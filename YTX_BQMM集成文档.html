<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<style type="text/css">
.ef0,.f0 { color: #000000; } .eb0,.b0 { background-color: #000000; }
.ef1,.f1 { color: #AA0000; } .eb1,.b1 { background-color: #AA0000; }
.ef2,.f2 { color: #00AA00; } .eb2,.b2 { background-color: #00AA00; }
.ef3,.f3 { color: #AA5500; } .eb3,.b3 { background-color: #AA5500; }
.ef4,.f4 { color: #0000AA; } .eb4,.b4 { background-color: #0000AA; }
.ef5,.f5 { color: #AA00AA; } .eb5,.b5 { background-color: #AA00AA; }
.ef6,.f6 { color: #FF55FF; } .eb6,.b6 { background-color: #FF55FF; }
.ef7,.f7 { color: #AAAAAA; } .eb7,.b7 { background-color: #AAAAAA; }
.ef8, .f0 > .bold,.bold > .f0 { color: #555555; font-weight: normal; }
.ef9, .f1 > .bold,.bold > .f1 { color: #FF5555; font-weight: normal; }
.ef10,.f2 > .bold,.bold > .f2 { color: #55FF55; font-weight: normal; }
.ef11,.f3 > .bold,.bold > .f3 { color: #FFFF55; font-weight: normal; }
.ef12,.f4 > .bold,.bold > .f4 { color: #5555FF; font-weight: normal; }
.ef13,.f5 > .bold,.bold > .f5 { color: #FF55FF; font-weight: normal; }
.ef14,.f6 > .bold,.bold > .f6 { color: #55FFFF; font-weight: normal; }
.ef15,.f7 > .bold,.bold > .f7 { color: #FFFFFF; font-weight: normal; }
.eb8  { background-color: #555555; }
.eb9  { background-color: #FF5555; }
.eb10 { background-color: #55FF55; }
.eb11 { background-color: #FFFF55; }
.eb12 { background-color: #5555FF; }
.eb13 { background-color: #FF55FF; }
.eb14 { background-color: #55FFFF; }
.eb15 { background-color: #FFFFFF; }
.ef16 { color: #000000; } .eb16 { background-color: #000000; }
.ef17 { color: #00005f; } .eb17 { background-color: #00005f; }
.ef18 { color: #000087; } .eb18 { background-color: #000087; }
.ef19 { color: #0000af; } .eb19 { background-color: #0000af; }
.ef20 { color: #0000d7; } .eb20 { background-color: #0000d7; }
.ef21 { color: #0000ff; } .eb21 { background-color: #0000ff; }
.ef22 { color: #005f00; } .eb22 { background-color: #005f00; }
.ef23 { color: #005f5f; } .eb23 { background-color: #005f5f; }
.ef24 { color: #005f87; } .eb24 { background-color: #005f87; }
.ef25 { color: #005faf; } .eb25 { background-color: #005faf; }
.ef26 { color: #005fd7; } .eb26 { background-color: #005fd7; }
.ef27 { color: #005fff; } .eb27 { background-color: #005fff; }
.ef28 { color: #008700; } .eb28 { background-color: #008700; }
.ef29 { color: #00875f; } .eb29 { background-color: #00875f; }
.ef30 { color: #008787; } .eb30 { background-color: #008787; }
.ef31 { color: #0087af; } .eb31 { background-color: #0087af; }
.ef32 { color: #0087d7; } .eb32 { background-color: #0087d7; }
.ef33 { color: #0087ff; } .eb33 { background-color: #0087ff; }
.ef34 { color: #00af00; } .eb34 { background-color: #00af00; }
.ef35 { color: #00af5f; } .eb35 { background-color: #00af5f; }
.ef36 { color: #00af87; } .eb36 { background-color: #00af87; }
.ef37 { color: #00afaf; } .eb37 { background-color: #00afaf; }
.ef38 { color: #00afd7; } .eb38 { background-color: #00afd7; }
.ef39 { color: #00afff; } .eb39 { background-color: #00afff; }
.ef40 { color: #00d700; } .eb40 { background-color: #00d700; }
.ef41 { color: #00d75f; } .eb41 { background-color: #00d75f; }
.ef42 { color: #00d787; } .eb42 { background-color: #00d787; }
.ef43 { color: #00d7af; } .eb43 { background-color: #00d7af; }
.ef44 { color: #00d7d7; } .eb44 { background-color: #00d7d7; }
.ef45 { color: #00d7ff; } .eb45 { background-color: #00d7ff; }
.ef46 { color: #00ff00; } .eb46 { background-color: #00ff00; }
.ef47 { color: #00ff5f; } .eb47 { background-color: #00ff5f; }
.ef48 { color: #00ff87; } .eb48 { background-color: #00ff87; }
.ef49 { color: #00ffaf; } .eb49 { background-color: #00ffaf; }
.ef50 { color: #00ffd7; } .eb50 { background-color: #00ffd7; }
.ef51 { color: #00ffff; } .eb51 { background-color: #00ffff; }
.ef52 { color: #5f0000; } .eb52 { background-color: #5f0000; }
.ef53 { color: #5f005f; } .eb53 { background-color: #5f005f; }
.ef54 { color: #5f0087; } .eb54 { background-color: #5f0087; }
.ef55 { color: #5f00af; } .eb55 { background-color: #5f00af; }
.ef56 { color: #5f00d7; } .eb56 { background-color: #5f00d7; }
.ef57 { color: #5f00ff; } .eb57 { background-color: #5f00ff; }
.ef58 { color: #5f5f00; } .eb58 { background-color: #5f5f00; }
.ef59 { color: #5f5f5f; } .eb59 { background-color: #5f5f5f; }
.ef60 { color: #5f5f87; } .eb60 { background-color: #5f5f87; }
.ef61 { color: #5f5faf; } .eb61 { background-color: #5f5faf; }
.ef62 { color: #5f5fd7; } .eb62 { background-color: #5f5fd7; }
.ef63 { color: #5f5fff; } .eb63 { background-color: #5f5fff; }
.ef64 { color: #5f8700; } .eb64 { background-color: #5f8700; }
.ef65 { color: #5f875f; } .eb65 { background-color: #5f875f; }
.ef66 { color: #5f8787; } .eb66 { background-color: #5f8787; }
.ef67 { color: #5f87af; } .eb67 { background-color: #5f87af; }
.ef68 { color: #5f87d7; } .eb68 { background-color: #5f87d7; }
.ef69 { color: #5f87ff; } .eb69 { background-color: #5f87ff; }
.ef70 { color: #5faf00; } .eb70 { background-color: #5faf00; }
.ef71 { color: #5faf5f; } .eb71 { background-color: #5faf5f; }
.ef72 { color: #5faf87; } .eb72 { background-color: #5faf87; }
.ef73 { color: #5fafaf; } .eb73 { background-color: #5fafaf; }
.ef74 { color: #5fafd7; } .eb74 { background-color: #5fafd7; }
.ef75 { color: #5fafff; } .eb75 { background-color: #5fafff; }
.ef76 { color: #5fd700; } .eb76 { background-color: #5fd700; }
.ef77 { color: #5fd75f; } .eb77 { background-color: #5fd75f; }
.ef78 { color: #5fd787; } .eb78 { background-color: #5fd787; }
.ef79 { color: #5fd7af; } .eb79 { background-color: #5fd7af; }
.ef80 { color: #5fd7d7; } .eb80 { background-color: #5fd7d7; }
.ef81 { color: #5fd7ff; } .eb81 { background-color: #5fd7ff; }
.ef82 { color: #5fff00; } .eb82 { background-color: #5fff00; }
.ef83 { color: #5fff5f; } .eb83 { background-color: #5fff5f; }
.ef84 { color: #5fff87; } .eb84 { background-color: #5fff87; }
.ef85 { color: #5fffaf; } .eb85 { background-color: #5fffaf; }
.ef86 { color: #5fffd7; } .eb86 { background-color: #5fffd7; }
.ef87 { color: #5fffff; } .eb87 { background-color: #5fffff; }
.ef88 { color: #870000; } .eb88 { background-color: #870000; }
.ef89 { color: #87005f; } .eb89 { background-color: #87005f; }
.ef90 { color: #870087; } .eb90 { background-color: #870087; }
.ef91 { color: #8700af; } .eb91 { background-color: #8700af; }
.ef92 { color: #8700d7; } .eb92 { background-color: #8700d7; }
.ef93 { color: #8700ff; } .eb93 { background-color: #8700ff; }
.ef94 { color: #875f00; } .eb94 { background-color: #875f00; }
.ef95 { color: #875f5f; } .eb95 { background-color: #875f5f; }
.ef96 { color: #875f87; } .eb96 { background-color: #875f87; }
.ef97 { color: #875faf; } .eb97 { background-color: #875faf; }
.ef98 { color: #875fd7; } .eb98 { background-color: #875fd7; }
.ef99 { color: #875fff; } .eb99 { background-color: #875fff; }
.ef100 { color: #878700; } .eb100 { background-color: #878700; }
.ef101 { color: #87875f; } .eb101 { background-color: #87875f; }
.ef102 { color: #878787; } .eb102 { background-color: #878787; }
.ef103 { color: #8787af; } .eb103 { background-color: #8787af; }
.ef104 { color: #8787d7; } .eb104 { background-color: #8787d7; }
.ef105 { color: #8787ff; } .eb105 { background-color: #8787ff; }
.ef106 { color: #87af00; } .eb106 { background-color: #87af00; }
.ef107 { color: #87af5f; } .eb107 { background-color: #87af5f; }
.ef108 { color: #87af87; } .eb108 { background-color: #87af87; }
.ef109 { color: #87afaf; } .eb109 { background-color: #87afaf; }
.ef110 { color: #87afd7; } .eb110 { background-color: #87afd7; }
.ef111 { color: #87afff; } .eb111 { background-color: #87afff; }
.ef112 { color: #87d700; } .eb112 { background-color: #87d700; }
.ef113 { color: #87d75f; } .eb113 { background-color: #87d75f; }
.ef114 { color: #87d787; } .eb114 { background-color: #87d787; }
.ef115 { color: #87d7af; } .eb115 { background-color: #87d7af; }
.ef116 { color: #87d7d7; } .eb116 { background-color: #87d7d7; }
.ef117 { color: #87d7ff; } .eb117 { background-color: #87d7ff; }
.ef118 { color: #87ff00; } .eb118 { background-color: #87ff00; }
.ef119 { color: #87ff5f; } .eb119 { background-color: #87ff5f; }
.ef120 { color: #87ff87; } .eb120 { background-color: #87ff87; }
.ef121 { color: #87ffaf; } .eb121 { background-color: #87ffaf; }
.ef122 { color: #87ffd7; } .eb122 { background-color: #87ffd7; }
.ef123 { color: #87ffff; } .eb123 { background-color: #87ffff; }
.ef124 { color: #af0000; } .eb124 { background-color: #af0000; }
.ef125 { color: #af005f; } .eb125 { background-color: #af005f; }
.ef126 { color: #af0087; } .eb126 { background-color: #af0087; }
.ef127 { color: #af00af; } .eb127 { background-color: #af00af; }
.ef128 { color: #af00d7; } .eb128 { background-color: #af00d7; }
.ef129 { color: #af00ff; } .eb129 { background-color: #af00ff; }
.ef130 { color: #af5f00; } .eb130 { background-color: #af5f00; }
.ef131 { color: #af5f5f; } .eb131 { background-color: #af5f5f; }
.ef132 { color: #af5f87; } .eb132 { background-color: #af5f87; }
.ef133 { color: #af5faf; } .eb133 { background-color: #af5faf; }
.ef134 { color: #af5fd7; } .eb134 { background-color: #af5fd7; }
.ef135 { color: #af5fff; } .eb135 { background-color: #af5fff; }
.ef136 { color: #af8700; } .eb136 { background-color: #af8700; }
.ef137 { color: #af875f; } .eb137 { background-color: #af875f; }
.ef138 { color: #af8787; } .eb138 { background-color: #af8787; }
.ef139 { color: #af87af; } .eb139 { background-color: #af87af; }
.ef140 { color: #af87d7; } .eb140 { background-color: #af87d7; }
.ef141 { color: #af87ff; } .eb141 { background-color: #af87ff; }
.ef142 { color: #afaf00; } .eb142 { background-color: #afaf00; }
.ef143 { color: #afaf5f; } .eb143 { background-color: #afaf5f; }
.ef144 { color: #afaf87; } .eb144 { background-color: #afaf87; }
.ef145 { color: #afafaf; } .eb145 { background-color: #afafaf; }
.ef146 { color: #afafd7; } .eb146 { background-color: #afafd7; }
.ef147 { color: #afafff; } .eb147 { background-color: #afafff; }
.ef148 { color: #afd700; } .eb148 { background-color: #afd700; }
.ef149 { color: #afd75f; } .eb149 { background-color: #afd75f; }
.ef150 { color: #afd787; } .eb150 { background-color: #afd787; }
.ef151 { color: #afd7af; } .eb151 { background-color: #afd7af; }
.ef152 { color: #afd7d7; } .eb152 { background-color: #afd7d7; }
.ef153 { color: #afd7ff; } .eb153 { background-color: #afd7ff; }
.ef154 { color: #afff00; } .eb154 { background-color: #afff00; }
.ef155 { color: #afff5f; } .eb155 { background-color: #afff5f; }
.ef156 { color: #afff87; } .eb156 { background-color: #afff87; }
.ef157 { color: #afffaf; } .eb157 { background-color: #afffaf; }
.ef158 { color: #afffd7; } .eb158 { background-color: #afffd7; }
.ef159 { color: #afffff; } .eb159 { background-color: #afffff; }
.ef160 { color: #d70000; } .eb160 { background-color: #d70000; }
.ef161 { color: #d7005f; } .eb161 { background-color: #d7005f; }
.ef162 { color: #d70087; } .eb162 { background-color: #d70087; }
.ef163 { color: #d700af; } .eb163 { background-color: #d700af; }
.ef164 { color: #d700d7; } .eb164 { background-color: #d700d7; }
.ef165 { color: #d700ff; } .eb165 { background-color: #d700ff; }
.ef166 { color: #d75f00; } .eb166 { background-color: #d75f00; }
.ef167 { color: #d75f5f; } .eb167 { background-color: #d75f5f; }
.ef168 { color: #d75f87; } .eb168 { background-color: #d75f87; }
.ef169 { color: #d75faf; } .eb169 { background-color: #d75faf; }
.ef170 { color: #d75fd7; } .eb170 { background-color: #d75fd7; }
.ef171 { color: #d75fff; } .eb171 { background-color: #d75fff; }
.ef172 { color: #d78700; } .eb172 { background-color: #d78700; }
.ef173 { color: #d7875f; } .eb173 { background-color: #d7875f; }
.ef174 { color: #d78787; } .eb174 { background-color: #d78787; }
.ef175 { color: #d787af; } .eb175 { background-color: #d787af; }
.ef176 { color: #d787d7; } .eb176 { background-color: #d787d7; }
.ef177 { color: #d787ff; } .eb177 { background-color: #d787ff; }
.ef178 { color: #d7af00; } .eb178 { background-color: #d7af00; }
.ef179 { color: #d7af5f; } .eb179 { background-color: #d7af5f; }
.ef180 { color: #d7af87; } .eb180 { background-color: #d7af87; }
.ef181 { color: #d7afaf; } .eb181 { background-color: #d7afaf; }
.ef182 { color: #d7afd7; } .eb182 { background-color: #d7afd7; }
.ef183 { color: #d7afff; } .eb183 { background-color: #d7afff; }
.ef184 { color: #d7d700; } .eb184 { background-color: #d7d700; }
.ef185 { color: #d7d75f; } .eb185 { background-color: #d7d75f; }
.ef186 { color: #d7d787; } .eb186 { background-color: #d7d787; }
.ef187 { color: #d7d7af; } .eb187 { background-color: #d7d7af; }
.ef188 { color: #d7d7d7; } .eb188 { background-color: #d7d7d7; }
.ef189 { color: #d7d7ff; } .eb189 { background-color: #d7d7ff; }
.ef190 { color: #d7ff00; } .eb190 { background-color: #d7ff00; }
.ef191 { color: #d7ff5f; } .eb191 { background-color: #d7ff5f; }
.ef192 { color: #d7ff87; } .eb192 { background-color: #d7ff87; }
.ef193 { color: #d7ffaf; } .eb193 { background-color: #d7ffaf; }
.ef194 { color: #d7ffd7; } .eb194 { background-color: #d7ffd7; }
.ef195 { color: #d7ffff; } .eb195 { background-color: #d7ffff; }
.ef196 { color: #ff0000; } .eb196 { background-color: #ff0000; }
.ef197 { color: #ff005f; } .eb197 { background-color: #ff005f; }
.ef198 { color: #ff0087; } .eb198 { background-color: #ff0087; }
.ef199 { color: #ff00af; } .eb199 { background-color: #ff00af; }
.ef200 { color: #ff00d7; } .eb200 { background-color: #ff00d7; }
.ef201 { color: #ff00ff; } .eb201 { background-color: #ff00ff; }
.ef202 { color: #ff5f00; } .eb202 { background-color: #ff5f00; }
.ef203 { color: #ff5f5f; } .eb203 { background-color: #ff5f5f; }
.ef204 { color: #ff5f87; } .eb204 { background-color: #ff5f87; }
.ef205 { color: #ff5faf; } .eb205 { background-color: #ff5faf; }
.ef206 { color: #ff5fd7; } .eb206 { background-color: #ff5fd7; }
.ef207 { color: #ff5fff; } .eb207 { background-color: #ff5fff; }
.ef208 { color: #ff8700; } .eb208 { background-color: #ff8700; }
.ef209 { color: #ff875f; } .eb209 { background-color: #ff875f; }
.ef210 { color: #ff8787; } .eb210 { background-color: #ff8787; }
.ef211 { color: #ff87af; } .eb211 { background-color: #ff87af; }
.ef212 { color: #ff87d7; } .eb212 { background-color: #ff87d7; }
.ef213 { color: #ff87ff; } .eb213 { background-color: #ff87ff; }
.ef214 { color: #ffaf00; } .eb214 { background-color: #ffaf00; }
.ef215 { color: #ffaf5f; } .eb215 { background-color: #ffaf5f; }
.ef216 { color: #ffaf87; } .eb216 { background-color: #ffaf87; }
.ef217 { color: #ffafaf; } .eb217 { background-color: #ffafaf; }
.ef218 { color: #ffafd7; } .eb218 { background-color: #ffafd7; }
.ef219 { color: #ffafff; } .eb219 { background-color: #ffafff; }
.ef220 { color: #ffd700; } .eb220 { background-color: #ffd700; }
.ef221 { color: #ffd75f; } .eb221 { background-color: #ffd75f; }
.ef222 { color: #ffd787; } .eb222 { background-color: #ffd787; }
.ef223 { color: #ffd7af; } .eb223 { background-color: #ffd7af; }
.ef224 { color: #ffd7d7; } .eb224 { background-color: #ffd7d7; }
.ef225 { color: #ffd7ff; } .eb225 { background-color: #ffd7ff; }
.ef226 { color: #ffff00; } .eb226 { background-color: #ffff00; }
.ef227 { color: #ffff5f; } .eb227 { background-color: #ffff5f; }
.ef228 { color: #ffff87; } .eb228 { background-color: #ffff87; }
.ef229 { color: #ffffaf; } .eb229 { background-color: #ffffaf; }
.ef230 { color: #ffffd7; } .eb230 { background-color: #ffffd7; }
.ef231 { color: #ffffff; } .eb231 { background-color: #ffffff; }
.ef232 { color: #080808; } .eb232 { background-color: #080808; }
.ef233 { color: #121212; } .eb233 { background-color: #121212; }
.ef234 { color: #1c1c1c; } .eb234 { background-color: #1c1c1c; }
.ef235 { color: #262626; } .eb235 { background-color: #262626; }
.ef236 { color: #303030; } .eb236 { background-color: #303030; }
.ef237 { color: #3a3a3a; } .eb237 { background-color: #3a3a3a; }
.ef238 { color: #444444; } .eb238 { background-color: #444444; }
.ef239 { color: #4e4e4e; } .eb239 { background-color: #4e4e4e; }
.ef240 { color: #585858; } .eb240 { background-color: #585858; }
.ef241 { color: #626262; } .eb241 { background-color: #626262; }
.ef242 { color: #6c6c6c; } .eb242 { background-color: #6c6c6c; }
.ef243 { color: #767676; } .eb243 { background-color: #767676; }
.ef244 { color: #808080; } .eb244 { background-color: #808080; }
.ef245 { color: #8a8a8a; } .eb245 { background-color: #8a8a8a; }
.ef246 { color: #949494; } .eb246 { background-color: #949494; }
.ef247 { color: #9e9e9e; } .eb247 { background-color: #9e9e9e; }
.ef248 { color: #a8a8a8; } .eb248 { background-color: #a8a8a8; }
.ef249 { color: #b2b2b2; } .eb249 { background-color: #b2b2b2; }
.ef250 { color: #bcbcbc; } .eb250 { background-color: #bcbcbc; }
.ef251 { color: #c6c6c6; } .eb251 { background-color: #c6c6c6; }
.ef252 { color: #d0d0d0; } .eb252 { background-color: #d0d0d0; }
.ef253 { color: #dadada; } .eb253 { background-color: #dadada; }
.ef254 { color: #e4e4e4; } .eb254 { background-color: #e4e4e4; }
.ef255 { color: #eeeeee; } .eb255 { background-color: #eeeeee; }

.f9 { color: #000000; }
.b9 { background-color: #FFFFFF; }
.f9 > .bold,.bold > .f9, body.f9 > pre > .bold {
  /* Bold is heavy black on white, or bright white
     depending on the default background */
  color: #5555FF;
  font-weight: bold;
}
.reverse {
  /* CSS does not support swapping fg and bg colours unfortunately,
     so just hardcode something that will look OK on all backgrounds. */
  color: #000000; background-color: #AAAAAA;
}
.underline { text-decoration: underline; }
.line-through { text-decoration: line-through; }
.blink { text-decoration: blink; }

/* Avoid pixels between adjacent span elements.
   Note this only works for lines less than 80 chars
   where we close span elements on the same line.
span { display: inline-block; }
*/
</style>
</head>

<body class="f9 b9">
  <body class="f9 b9">
  <h1>说明：</h1>
    <ul>
    	<li>
    		<p>
    			本Demo使用的是
    			<a href="http://www.yuntongxun.com/doc/ready/demo/1_4_1_1.html">版本号为v5.3r 云通讯官方IMDemo</a>
    		</p>
    	</li>
    	<li>
    		<p>
    			本Demo在云通讯官方Demo的基础上集成了BQMM1.7,在修改的地方我们都加上了“BQMM集成"的注释，可在项目中全局搜索查看
    		</p>
    	</li>
    	<li>
    		<p>
    			我们提供了集成之后的Demo与官方Demo的Diff文档,供大家查看 (绿色为新增的代码，红色为删除的代码)
    		</p>
    	</li>
    </ul>


    <h1>
    	集成之后的Demo与官方Demo的Diff文档：
    </h1>
<pre>
<span class="bold">diff --git a/ECSDKDemo_OC/ECSDKDemo_OC/AppDelegate.mm b/ECSDKDemo_OC/ECSDKDemo_OC/AppDelegate.mm</span>
<span class="bold">index 210213d..94fbf10 100755</span>
<span class="bold">--- a/ECSDKDemo_OC/ECSDKDemo_OC/AppDelegate.mm</span>
<span class="bold">+++ b/ECSDKDemo_OC/ECSDKDemo_OC/AppDelegate.mm</span>
<span class="f6">@@ -16,6 +16,8 @@</span>
#import &lt;ShareSDKConnector/ShareSDKConnector.h&gt;
#import &quot;WXApi.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>

#define LOG_OPEN 0

<span class="f6">@@ -106,8 +108,16 @@</span> - (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(
        rootView = [[UINavigationController alloc] initWithRootViewController:_loginView];
    }

    <span class="f2">//BQMM集成  初始化BQMM</span>
<span class="f2">    NSString *appId = @&quot;yourAppID&quot;;</span>
<span class="f2">    NSString *appSecret = @&quot;yourSecret&quot;;</span>
    [[<span class="f1">UINavigationBar appearance</span><span class="f2">MMEmotionCentre defaultCentre</span>] <span class="f1">setTitleTextAttributes</span><span class="f2">setAppId</span>:<span class="f1">@{NSForegroundColorAttributeName</span><span class="f2">appId secret</span>:<span class="f2">appSecret];
    </span>
<span class="f2">    [MMEmotionCentre defaultCentre].sdkMode = MMSDKModeIM;</span>
    [<span class="f1">UIColor whiteColor</span><span class="f2">MMEmotionCentre defaultCentre</span>]<span class="f1">}</span><span class="f2">.sdkLanguage = MMLanguageChinese;</span>
<span class="f2">    [MMEmotionCentre defaultCentre</span>]<span class="f2">.sdkRegion = MMRegionOther</span>;

    <span class="f2">[[UINavigationBar appearance] setTitleTextAttributes:@{NSForegroundColorAttributeName:[UIColor whiteColor]}];</span>
    self.window.rootViewController = rootView;

    [self.window makeKeyAndVisible];
<span class="f6">@@ -227,6 +237,8 @@</span> - (void)applicationDidEnterBackground:(UIApplication *)application {

- (void)applicationWillEnterForeground:(UIApplication *)application {
    // Called as part of the transition from the background to the inactive state; here you can undo many of the changes made on entering the background.
    <span class="f2">//BQMM集成</span>
<span class="f2">    [[MMEmotionCentre defaultCentre] clearSession];</span>
}

- (void)applicationDidBecomeActive:(UIApplication *)application {
<span class="bold">diff --git a/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewCell.m b/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewCell.m
index 1ef4f6c..edb0d02 100755</span>
<span class="bold">--- a/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewCell.m</span>
<span class="bold">+++ b/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewCell.m</span>
<span class="f6">@@ -82,6 +82,7 @@</span> -(instancetype) initWithIsSender:(BOOL)aIsSender reuseIdentifier:(NSString *)reu
            UIImageView *bubleimg = [[UIImageView alloc] initWithFrame:self.bubbleView.bounds];
            bubleimg.image = [[UIImage imageNamed:@&quot;chat_receiver_bg&quot;] stretchableImageWithLeftCapWidth:33.0f topCapHeight:33.0f];
            bubleimg.tag = 1000;
            <span class="f2">_bubleimg = bubleimg;  //BQMM集成</span>
            [self.bubbleView addSubview:bubleimg];
            bubleimg.autoresizingMask = UIViewAutoresizingFlexibleWidth|UIViewAutoresizingFlexibleHeight;
            [self.contentView addSubview:self.bubbleView];
<span class="f6">@@ -105,6 +106,13 @@</span> -(instancetype) initWithIsSender:(BOOL)aIsSender reuseIdentifier:(NSString *)reu
    return self;
}

<span class="f2">//BQMM 集成</span>
<span class="f2">- (void)prepareForReuse {</span>
<span class="f2">    [super prepareForReuse];</span>
<span class="f2">    self.displayMessage = nil;</span>
<span class="f2">    self.bubleimg.hidden = NO;</span>
<span class="f2">}</span>

- (BOOL)canBecomeFirstResponder{
    return YES;
}
<span class="bold">diff --git a/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewImageCell.m b/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewImageCell.m
index 4dce7e4..2f75218 100755</span>
<span class="bold">--- a/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewImageCell.m</span>
<span class="bold">+++ b/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewImageCell.m</span>
<span class="f6">@@ -11,6 +11,9 @@</span>
#import &quot;UIImage+MultiFormat.h&quot;
#import &quot;NSString+containsString.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>

#if __IPHONE_OS_VERSION_MAX_ALLOWED &gt; __IPHONE_6_1
#define kCGImageAlphaPremultipliedLast  (kCGBitmapByteOrderDefault | kCGImageAlphaPremultipliedLast)
#else
<span class="f6">@@ -97,12 +100,12 @@</span> -(void)getImageWithwidth:(CGFloat)width andgetImageWithhight:(CGFloat)hight {

    ECMessage *message = self.displayMessage;
    ECImageMessageBody *mediaBody = (ECImageMessageBody*)message.messageBody;
<span class="f2">//</span>    if ([@&quot;gif&quot; isEqualToString:mediaBody.localPath.pathExtension.lowercaseString]) {
<span class="f2">//</span>        _gifFlagImage.hidden = NO;
<span class="f2">//</span>        _gifFlagImage.center = CGPointMake(_displayImage.frame.size.width*0.5, _displayImage.frame.size.height*0.5);
<span class="f2">//</span>    } else {
<span class="f2">//</span>        _gifFlagImage.hidden = YES;
<span class="f2">//</span>    }

    [super updateMessageSendStatus:self.displayMessage.messageState];
}
<span class="f6">@@ -114,6 +117,38 @@</span> -(void)layoutSubviews {
    ECMessage *message = self.displayMessage;
    ECImageMessageBody *mediaBody = (ECImageMessageBody*)message.messageBody;



    <span class="f2">//解析消息扩展</span>
<span class="f2">    NSString *extString = message.userData;</span>
<span class="f2">    NSDictionary *extDic = nil;</span>
<span class="f2">    if (extString != nil) {</span>
<span class="f2">        NSData *extData = [extString dataUsingEncoding:NSUTF8StringEncoding];</span>
<span class="f2">        extDic = [NSJSONSerialization JSONObjectWithData:extData options:NSJSONReadingMutableLeaves error:nil];</span>
<span class="f2">    }</span>
<span class="f2">    if (extDic != nil &amp;&amp; [extDic[@&quot;txt_msgType&quot;] isEqualToString: @&quot;facetype&quot;]) { //大表情消息</span>
<span class="f2">        self.bubleimg.hidden = YES;</span>
<span class="f2">        [self getImageWithwidth:120 andgetImageWithhight:120];</span>
<span class="f2">        _displayImage.image = [UIImage imageNamed:@&quot;mm_emoji_loading&quot;];</span>
<span class="f2">        NSArray *codes = nil;</span>
<span class="f2">        if (extDic[@&quot;msg_data&quot;]) {</span>
<span class="f2">            codes = @[extDic[@&quot;msg_data&quot;][0][0]];</span>
<span class="f2">        }</span>
<span class="f2">        __weak typeof(self) weakself = self;</span>
<span class="f2">        [[MMEmotionCentre defaultCentre] fetchEmojisByType:MMFetchTypeBig codes:codes completionHandler:^(NSArray *emojis) {</span>
<span class="f2">            if (emojis.count &gt; 0) {</span>
<span class="f2">                MMEmoji *emoji = emojis[0];</span>
<span class="f2">                if ([codes[0] isEqualToString:emoji.emojiCode]) {</span>
<span class="f2">                    _displayImage.image = emoji.emojiImage; //TODO</span>
<span class="f2">                }</span>
<span class="f2">            }</span>
<span class="f2">            else {</span>
<span class="f2">                _displayImage.image = [UIImage imageNamed:@&quot;mm_emoji_error&quot;];</span>
<span class="f2">            }</span>
<span class="f2">        }];</span>
<span class="f2">        return;</span>
<span class="f2">    }</span>

    UIImage* defaultimg = [UIImage imageNamed:@&quot;chat_placeholder_image&quot;];
    _displayImage.image = defaultimg;

<span class="bold">diff --git a/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewTextCell.h b/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewTextCell.h</span>
<span class="bold">index f8f9f79..9aae53c 100755</span>
<span class="bold">--- a/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewTextCell.h</span>
<span class="bold">+++ b/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewTextCell.h</span>
<span class="f6">@@ -11,4 +11,7 @@</span> extern NSString *const KResponderCustomChatViewTextCellBubbleViewEvent;
extern NSString *const KResponderCustomChatViewTextLnkCellBubbleViewEvent;
@interface ChatViewTextCell : ChatViewCell

<span class="f2">//BQMM集成</span>
<span class="f2">+(CGFloat)getHightOfCellViewWithMessage:(ECMessage *)message;</span>

@end
<span class="bold">diff --git a/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewTextCell.m b/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewTextCell.m</span>
<span class="bold">index 3c4b745..0ab31c9 100755</span>
<span class="bold">--- a/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewTextCell.m</span>
<span class="bold">+++ b/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewCell/ChatViewTextCell.m</span>
<span class="f6">@@ -8,11 +8,16 @@</span>
#import &lt;CoreText/CoreText.h&gt;
#import &quot;ChatViewTextCell.h&quot;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &quot;MMTextView.h&quot;</span>
<span class="f2">#import &quot;MMTextParser.h&quot;</span>


NSString *const KResponderCustomChatViewTextCellBubbleViewEvent = @&quot;KResponderCustomChatViewTextCellBubbleViewEvent&quot;;
NSString *const KResponderCustomChatViewTextLnkCellBubbleViewEvent = @&quot;KResponderCustomChatViewTextLnkCellBubbleViewEvent&quot;;
#define LabelFont [UIFont systemFontOfSize:15.0f]
#define BubbleMaxSize CGSizeMake(180.0f, 10000.0f)
@interface ChatViewTextCell()<span class="f2">&lt;MMTextViewDelegate, MMTextViewDelegate&gt;  //BQMM集成</span>
@property (nonatomic, strong)NSDataDetector *detector;
@property (nonatomic, strong) NSArray *urlMatches;
@property (nonatomic, copy) NSString *url;
<span class="f6">@@ -20,15 +25,20 @@</span> @interface ChatViewTextCell()
@implementation ChatViewTextCell
{
    UILabel *_label;
    <span class="f2">MMTextView *_textView; //BQMM集成</span>
}

-(instancetype) initWithIsSender:(BOOL)isSender reuseIdentifier:(NSString *)reuseIdentifier{
    if (self = [super initWithIsSender:isSender reuseIdentifier:reuseIdentifier]) {
        if (isSender) {
            _label = [[UILabel alloc] initWithFrame:CGRectMake(5.0f, 2.0f, self.bubbleView.frame.size.width-15.0f, self.bubbleView.frame.size.height-6.0f)];

            <span class="f2">_textView = [[MMTextView alloc] initWithFrame:CGRectMake(5.0f, 2.0f, self.bubbleView.frame.size.width-15.0f, self.bubbleView.frame.size.height-6.0f)];</span>
        }
        else{
            _label = [[UILabel alloc] initWithFrame:CGRectMake(10.0f, 2.0f, self.bubbleView.frame.size.width-15.0f, self.bubbleView.frame.size.height-6.0f)];

            <span class="f2">_textView = [[MMTextView alloc] initWithFrame:CGRectMake(10.0f, 2.0f, self.bubbleView.frame.size.width-15.0f, self.bubbleView.frame.size.height-6.0f)];</span>
        }
        self.detector = [NSDataDetector dataDetectorWithTypes:NSTextCheckingTypeLink error:nil];
        _label.numberOfLines = 0;
<span class="f6">@@ -36,6 +46,18 @@</span> -(instancetype) initWithIsSender:(BOOL)isSender reuseIdentifier:(NSString *)reus
        _label.lineBreakMode = NSLineBreakByCharWrapping;
        _label.backgroundColor = [UIColor clearColor];
        [self.bubbleView addSubview:_label];

        <span class="f2">//BQMM集成</span>
<span class="f2">        _label.hidden = true;</span>
<span class="f2">        </span>
<span class="f2">        _textView.mmFont = LabelFont;</span>
<span class="f2">        _textView.mmTextColor = [UIColor blackColor];</span>
<span class="f2">        _textView.backgroundColor = [UIColor clearColor];</span>
<span class="f2">        _textView.editable = NO;</span>
<span class="f2">        _textView.scrollEnabled = NO;</span>
<span class="f2">        _textView.selectable = NO;</span>
<span class="f2">        _textView.clickActionDelegate = self;</span>
<span class="f2">        [self.bubbleView addSubview:_textView];</span>
    }
    return self;
}
<span class="f6">@@ -68,6 +90,31 @@</span> -(void)bubbleViewTapGesture:(id)sender{
    }
}

<span class="f2">//BQMM集成</span>
<span class="f2">+(CGFloat)getHightOfCellViewWithMessage:(ECMessage *)message {</span>
<span class="f2">    CGFloat height = 65.0f;</span>
<span class="f2">    //解析消息扩展</span>
<span class="f2">    NSString *extString = message.userData;</span>
<span class="f2">    NSDictionary *extDic = nil;</span>
<span class="f2">    if (extString != nil) {</span>
<span class="f2">        NSData *extData = [extString dataUsingEncoding:NSUTF8StringEncoding];</span>
<span class="f2">        extDic = [NSJSONSerialization JSONObjectWithData:extData options:NSJSONReadingMutableLeaves error:nil];</span>
<span class="f2">    }</span>
<span class="f2">    CGSize contentSize = CGSizeZero;</span>
<span class="f2">    if (extDic != nil &amp;&amp; [extDic[@&quot;txt_msgType&quot;] isEqualToString: @&quot;emojitype&quot;]) { //大表情消息</span>
<span class="f2">        contentSize = [MMTextParser sizeForMMTextWithExtData:extDic[@&quot;msg_data&quot;] font:LabelFont maximumTextWidth:BubbleMaxSize.width];</span>
<span class="f2">    }else{</span>
<span class="f2">        ECTextMessageBody *body = (ECTextMessageBody*)message.messageBody;</span>
<span class="f2">        contentSize = [MMTextParser sizeForTextWithText:body.text font:LabelFont maximumTextWidth:BubbleMaxSize.width];</span>
<span class="f2">    }</span>
<span class="f2">    </span>
<span class="f2">    if (contentSize.height&gt;45.0f) {</span>
<span class="f2">        height = contentSize.height+20.0f;</span>
<span class="f2">    }</span>
<span class="f2">    return height;</span>
<span class="f2">    </span>
<span class="f2">}</span>

+(CGFloat)getHightOfCellViewWith:(ECMessageBody *)message{
    CGFloat height = 65.0f;
    ECTextMessageBody *body = (ECTextMessageBody*)message;
<span class="f6">@@ -219,6 +266,7 @@</span> - (void)highlightLinksWithIndex:(CFIndex)index {
    _label.attributedText = attributedString;
}

<span class="f2">//BQMM集成</span>
-(void)layoutSubviews{

    [super layoutSubviews];
<span class="f6">@@ -227,40 +275,88 @@</span> -(void)layoutSubviews{
    if (body.text==nil) {
        body.text=@&quot;&quot;;
    }

    <span class="f2">//解析消息扩展</span>
<span class="f2">    NSString *extString = self.displayMessage.userData;</span>
<span class="f2">    NSDictionary *extDic = nil;</span>
<span class="f2">    if (extString != nil) {</span>
<span class="f2">        NSData *extData = [extString dataUsingEncoding:NSUTF8StringEncoding];</span>
<span class="f2">        extDic = [NSJSONSerialization JSONObjectWithData:extData options:NSJSONReadingMutableLeaves error:nil];</span>
<span class="f2">    }</span>
<span class="f2">    CGSize contentSize = CGSizeZero;</span>
<span class="f2">    if (extDic != nil &amp;&amp; [extDic[@&quot;txt_msgType&quot;] isEqualToString: @&quot;emojitype&quot;]) { //大表情消息</span>
<span class="f2">        contentSize = [MMTextParser sizeForMMTextWithExtData:extDic[@&quot;msg_data&quot;] font:LabelFont maximumTextWidth:BubbleMaxSize.width];</span>
<span class="f2">        [_textView setMmTextData:extDic[@&quot;msg_data&quot;]];</span>
<span class="f2">    }else{</span>
<span class="f2">        contentSize = [MMTextParser sizeForTextWithText:body.text font:LabelFont maximumTextWidth:BubbleMaxSize.width];</span>
<span class="f2">        </span>
<span class="f2">//        _textView.mmText = body.text;   TODO </span>
<span class="f2">    }</span>

    <span class="f2">if (contentSize.height&lt;40.0f) {</span>
<span class="f2">        contentSize.height=40.0f;</span>
<span class="f2">    }</span>
<span class="f2">    </span>
<span class="f2">    [_textView setURLAttributes];</span>

<span class="f2">//</span>    self.urlMatches = [self.detector matchesInString:body.text options:0 range:NSMakeRange(0, body.text.length)];
<span class="f2">//</span>    NSMutableAttributedString * attributedString = [[NSMutableAttributedString alloc]
<span class="f2">//</span>                                                    initWithString:body.text];
<span class="f2">//</span>    NSMutableParagraphStyle * paragraphStyle = [[NSMutableParagraphStyle alloc] init];
<span class="f2">//</span>    [paragraphStyle setLineBreakMode:NSLineBreakByCharWrapping];
<span class="f2">//</span>    [attributedString addAttribute:NSParagraphStyleAttributeName
<span class="f2">//</span>                             value:paragraphStyle
<span class="f2">//</span>                             range:NSMakeRange(0, [body.text length])];
<span class="f2">//</span>    [attributedString addAttribute:NSFontAttributeName value:LabelFont range:NSMakeRange(0, [body.text length])];
<span class="f2">//    </span>
<span class="f2">//</span>    [_label setAttributedText:attributedString];
<span class="f2">//</span>    [self highlightLinksWithIndex:NSNotFound];

//    _label.text = body.text;


#pragma clang diagnostic push
#pragma clang diagnostic ignored &quot;-Wdeprecated-declarations&quot;
<span class="f2">//</span>    CGSize bubbleSize = [body.text sizeWithFont:LabelFont constrainedToSize:BubbleMaxSize lineBreakMode:NSLineBreakByCharWrapping];
#pragma clang diagnostic pop
<span class="f2">//</span>    if (bubbleSize.height&lt;40.0f) {
<span class="f2">//</span>        bubbleSize.height=40.0f;
<span class="f2">//</span>    }

    if (self.isSender) {
<span class="f2">//</span>        _label.frame = CGRectMake(9.0f, 2.0f, bubbleSize.width, bubbleSize.height);
<span class="f2">//</span>        self.bubbleView.frame = CGRectMake(self.portraitImg.frame.origin.x-bubbleSize.width-25.0f-10.0f, self.portraitImg.frame.origin.y, bubbleSize.width+25.0f, bubbleSize.height+6.0f);

        <span class="f2">self.bubbleView.frame = CGRectMake(self.portraitImg.frame.origin.x-contentSize.width-25.0f-10.0f, self.portraitImg.frame.origin.y, contentSize.width+25.0f, contentSize.height+6.0f);
        </span>
<span class="f2">        _textView.frame = CGRectMake(9.0f, (self.bubbleView.frame.size.height - contentSize.height) / 2, contentSize.width, contentSize.height);</span>
    } else {
<span class="f2">//</span>        _label.frame = CGRectMake(16.0f, 2.0f, bubbleSize.width, bubbleSize.height);
<span class="f2">//</span>        self.bubbleView.frame = CGRectMake(self.portraitImg.frame.origin.x+self.portraitImg.frame.size.width+10.0f, self.portraitImg.frame.origin.y, bubbleSize.width+25.0f, bubbleSize.height+6.0f);

        <span class="f2">self.bubbleView.frame = CGRectMake(self.portraitImg.frame.origin.x+self.portraitImg.frame.size.width+10.0f, self.portraitImg.frame.origin.y, contentSize.width+25.0f, contentSize.height+6.0f);
        _textView.frame = CGRectMake(16.0f, (self.bubbleView.frame.size.height - contentSize.height) / 2, contentSize.width, contentSize.height);</span>

    }

    [super updateMessageSendStatus:self.displayMessage.messageState];
}


<span class="f2">//BQMM集成</span>
<span class="f2">#pragma mark MMTextViewDelegate</span>
<span class="f2">- (void)mmTextView:(MMTextView *)textView didSelectLinkWithPhoneNumber:(NSString *)phoneNumber {</span>
<span class="f2">    NSString *number = [@&quot;tel://&quot; stringByAppendingString:phoneNumber];</span>
<span class="f2">    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:number]];</span>
<span class="f2">}</span>

<span class="f2">- (void)mmTextView:(MMTextView *)textView didSelectLinkWithURL:(NSURL *)url {</span>
<span class="f2">    NSString *urlString=[url absoluteString];</span>
<span class="f2">    if (![urlString hasPrefix:@&quot;http&quot;]) {</span>
<span class="f2">        urlString = [@&quot;http://&quot; stringByAppendingString:urlString];</span>
<span class="f2">    }</span>
<span class="f2">    </span>
<span class="f2">    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:urlString]];</span>
<span class="f2">}</span>

@end
<span class="bold">diff --git a/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewController.m b/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewController.m</span>
<span class="bold">index 0e11376..1c71727 100755</span>
<span class="bold">--- a/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewController.m</span>
<span class="bold">+++ b/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/Chat/ChatView/ChatViewController.m</span>
<span class="f6">@@ -57,6 +57,10 @@</span>

#import &lt;ShareSDK/ShareSDK.h&gt;

<span class="f2">//BQMM集成</span>
<span class="f2">#import &quot;MMTextParser.h&quot;</span>


#define ToolbarInputViewHeight 43.0f
#define ToolbarMoreViewHeight 120.0f
#define ToolbarMoreViewHeight1 163.0f
<span class="f6">@@ -85,7 +89,7 @@</span>
    UserState_Record,
}UserState;

@interface ChatViewController()&lt;UITableViewDataSource, UITableViewDelegate,HPGrowingTextViewDelegate,UIImagePickerControllerDelegate,UINavigationControllerDelegate,MWPhotoBrowserDelegate,CustomEmojiViewDelegate,UIActionSheetDelegate,ECDeviceVoiceRecordViewDelegate,ECLocationViewControllerDelegate,WebBrowserBaseViewControllerDelegate<span class="f2">, MMEmotionCentreDelegate</span>&gt; { <span class="f2">//BQMM集成
</span>    BOOL isGroup;
    dispatch_once_t emojiCreateOnce;
    dispatch_once_t scrollBTMOnce;
<span class="f6">@@ -149,7 +153,7 @@</span> @implementation ChatViewController{
    UIButton *_emojiBtn;
    UIButton *_switchVoiceBtn;
    UIButton *_moreBtn;
<span class="f2">//</span>    CustomEmojiView *_emojiView;    <span class="f2">BQMM集成 去掉原demo的表情键盘</span>
    NSString *_GroupMemberNickName;

    BOOL isReadDeleteMessage;
<span class="f6">@@ -269,6 +273,9 @@</span> -(void)viewDidLoad {
    char myBuffer[4] = {'\xe2','\x80','\x85',0};
    _deleteAtStr = [NSString stringWithCString:myBuffer encoding:NSUTF8StringEncoding];

    <span class="f2">//BQMM集成</span>
<span class="f2">    [[MMEmotionCentre defaultCentre] shouldShowShotcutPopoverAboveView:_emojiBtn withInput:_inputTextView.internalTextView];</span>

}

-(NSString*)getDeviceWithType:(ECDeviceType)type{
<span class="f6">@@ -393,6 +400,9 @@</span> -(void)viewWillAppear:(BOOL)animated {
    if (_isStartRecord) {
        _footView.hidden = NO;
    }

    <span class="f2">//BQMM集成</span>
<span class="f2">    [MMEmotionCentre defaultCentre].delegate = self;</span>
}

//view出现后触发
<span class="f6">@@ -402,23 +412,23 @@</span> -(void)viewDidAppear:(BOOL)animated {

    extern NSString *const Notification_ChangeMainDisplay;
    [[NSNotificationCenter defaultCenter] postNotificationName:Notification_ChangeMainDisplay object:@0];
    <span class="f2">//BQMM集成   去掉原demo的表情键盘</span>
<span class="f2">//</span>    dispatch_once(&amp;emojiCreateOnce, ^{
<span class="f2">//</span>        _emojiView = [CustomEmojiView shardInstance];
<span class="f2">//</span>        _emojiView.delegate = self;
<span class="f2">//</span>        _emojiView.frame = CGRectMake(0, self.view.frame.size.height, self.view.frame.size.width, 216.0f);
<span class="f2">//</span>    });
<span class="f2">//    </span>
<span class="f2">//</span>    BOOL isHas = NO;
<span class="f2">//</span>    for (UIView* view in self.view.subviews) {
<span class="f2">//</span>        if (view == _emojiView) {
<span class="f2">//</span>            isHas = YES;
<span class="f2">//</span>            break;
<span class="f2">//</span>        }
<span class="f2">//</span>    }
<span class="f2">//</span>    if (!isHas) {
<span class="f2">//</span>        [self.view addSubview:_emojiView];
<span class="f2">//</span>    }

    [[DeviceDBHelper sharedInstance] markMessagesAsReadOfSession:self.sessionId];
}
<span class="f6">@@ -439,6 +449,9 @@</span> -(void)viewWillDisappear:(BOOL)animated {

    [super viewWillDisappear:animated];
    _footView.hidden = YES;

    <span class="f2">//BQMM集成</span>
<span class="f2">    [MMEmotionCentre defaultCentre].delegate = nil;</span>
}

-(void)dealloc {
<span class="f6">@@ -647,52 +660,36 @@</span> - (void)keyboardWillChangeFrame:(NSNotification *)notification {
    CGRect beginFrame = [userInfo[UIKeyboardFrameBeginUserInfoKey] CGRectValue];
    CGFloat duration = [userInfo[UIKeyboardAnimationDurationUserInfoKey] doubleValue];
    CGFloat frameY = self.view.frame.size.height-ToolbarInputViewHeight;
    CGRect <span class="f1">frame</span><span class="f2">containerViewFrame</span> = _containerView.frame;

    if (beginFrame.origin.y == [[UIScreen mainScreen] bounds].size.height) {
        //显示键盘
<span class="f2">//</span>        toolbarDisplay = ToolbarDisplay_None;
        _isDisplayKeyborad = YES;

        //只显示输入view
        frameY = endFrame.origin.y-<span class="f1">_containerView.frame</span><span class="f2">containerViewFrame</span>.size.height+ToolbarMoreViewHeight;
    } else if (endFrame.origin.y == [[UIScreen mainScreen] bounds].size.height) {

        //隐藏键盘
        _isDisplayKeyborad = NO;
        <span class="f2">return;</span>
        //根据不同的类型显示toolbar
<span class="f2">//</span>        switch (toolbarDisplay) {
<span class="f1">case ToolbarDisplay_Emoji: {</span>
<span class="f1">                __weak __typeof(self)weakSelf = self;</span>
<span class="f1">                frameY = endFrame.origin.y-frame.size.height-93.0f;</span>
<span class="f1">                void(^animations)() = ^{</span>
<span class="f1">                    __strong __typeof(weakSelf)strongSelf = weakSelf;</span>
<span class="f1">                    if (strongSelf) {</span>
<span class="f1">                        CGRect frame = _emojiView.frame;</span>
<span class="f1">                        frame.origin.y = viewHeight-_emojiView.frame.size.height;</span>
<span class="f1">                        _emojiView.frame=frame;</span>
<span class="f1">                    }</span>
<span class="f1">                };</span>

<span class="f1">                [UIView animateWithDuration:0.25 delay:0.1f options:(UIViewAnimationOptionCurveEaseIn | UIViewAnimationOptionBeginFromCurrentState) animations:animations completion:nil];</span>
<span class="f1">            }</span>
<span class="f1">                break;</span><span class="f2">//</span>            case ToolbarDisplay_Record:
<span class="f2">//</span>                frameY = endFrame.origin.y<span class="f1">-frame</span><span class="f2">-containerViewFrame</span>.size.height-ToolbarInputViewHeight;
<span class="f2">//</span>                break;
<span class="f2">//                </span>
<span class="f2">//</span>            case ToolbarDisplay_More:
<span class="f2">//</span>                frameY = endFrame.origin.y<span class="f1">-frame</span><span class="f2">-containerViewFrame</span>.size.height-ToolbarInputViewHeight;
<span class="f2">//</span>                break;
<span class="f2">//                </span>
<span class="f2">//</span>            default:
<span class="f2">//</span>                frameY = endFrame.origin.y<span class="f1">-frame</span><span class="f2">-containerViewFrame</span>.size.height+ToolbarMoreViewHeight;
<span class="f2">//</span>                break;
<span class="f2">//</span>        }
    } else {
        frameY = endFrame.origin.y<span class="f1">-frame</span><span class="f2">-containerViewFrame</span>.size.height+ToolbarMoreViewHeight;
    }

    frameY -= 64.0f;
<span class="f6">@@ -701,17 +698,22 @@</span> - (void)keyboardWillChangeFrame:(NSNotification *)notification {
}

#pragma mark - UITableViewDelegate
<span class="f2">//BQMM集成</span>
- (void)scrollViewWillBeginDragging:(UIScrollView *)scrollView {
    NSLog(@&quot;scrollViewWillBeginDragging&quot;);
    [_footView removeFromSuperview];
    _footView = nil;
    isScrollToButtom = NO;
//    _footView.hidden = YES;
    <span class="f2">[self endEditing];</span>
    if (_isDisplayKeyborad) {
<span class="f1">[self.view endEditing:YES];</span>
    } else {
        [self toolbarDisplayChangedToFrameY:viewHeight-_containerView.frame.size.height+ToolbarMoreViewHeight andDuration:0.25];
        <span class="f2">[_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">        [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f2">        [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">        [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon_on&quot;] forState:UIControlStateHighlighted];</span>
    }
}

<span class="f6">@@ -750,9 +752,23 @@</span> - (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPa
    //根据cell内容获取高度
    CGFloat height = 0.0f;
    switch (message.messageBody.messageBodyType) {
        case MessageBodyType_Text:   <span class="f2">//BQMM集成</span>
<span class="f2">        {</span>
<span class="f2">            //解析消息扩展</span>
<span class="f2">            NSString *extString = message.userData;</span>
<span class="f2">            NSDictionary *extDic = nil;</span>
<span class="f2">            if (extString != nil) {</span>
<span class="f2">                NSData *extData = [extString dataUsingEncoding:NSUTF8StringEncoding];</span>
<span class="f2">                extDic = [NSJSONSerialization JSONObjectWithData:extData options:NSJSONReadingMutableLeaves error:nil];</span>
<span class="f2">            }</span>
<span class="f2">            if (extDic != nil &amp;&amp; [extDic[@&quot;txt_msgType&quot;] isEqualToString: @&quot;facetype&quot;]) { //大表情消息</span>
<span class="f2">                height = 150.0f;</span>
<span class="f2">            }else{</span>
                height = [ChatViewTextCell <span class="f1">getHightOfCellViewWith</span><span class="f2">getHightOfCellViewWithMessage</span>:message<span class="f1">.messageBody</span>];
            <span class="f2">}</span>

            break;
        <span class="f2">}</span>
        case MessageBodyType_Voice:
        case MessageBodyType_Video:
        case MessageBodyType_Image:
<span class="f6">@@ -861,15 +877,34 @@</span> - (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(N

    NSInteger fileType = message.messageBody.messageBodyType;

    <span class="f2">//BQMM集成</span>
<span class="f2">    //解析消息扩展</span>
<span class="f2">    NSString *extString = message.userData;</span>
<span class="f2">    NSDictionary *extDic = nil;</span>
<span class="f2">    if (extString != nil) {</span>
<span class="f2">        NSData *extData = [extString dataUsingEncoding:NSUTF8StringEncoding];</span>
<span class="f2">        extDic = [NSJSONSerialization JSONObjectWithData:extData options:NSJSONReadingMutableLeaves error:nil];</span>
<span class="f2">    }</span>
<span class="f2">    NSString *msgType = @&quot;none&quot;;</span>
<span class="f2">    if (extDic != nil) {</span>
<span class="f2">        msgType = extDic[@&quot;txt_msgType&quot;];</span>
<span class="f2">    }</span>

    NSString *cellidentifier = [NSString stringWithFormat:@&quot;%@_%@_%<span class="f1">d</span><span class="f2">d_%@</span>&quot;, isSender?@&quot;issender&quot;:@&quot;isreceiver&quot;,NSStringFromClass([message.messageBody class]),(int)fileType<span class="f2">, msgType</span>];

    ChatViewCell *cell = [tableView dequeueReusableCellWithIdentifier:cellidentifier];
    if (cell == nil) {
        switch (message.messageBody.messageBodyType) {

            case MessageBodyType_Text:   <span class="f2">//BQMM集成</span>
<span class="f2">            {</span>
<span class="f2">                if (extDic != nil &amp;&amp; [extDic[@&quot;txt_msgType&quot;] isEqualToString: @&quot;facetype&quot;]) { //大表情消息</span>
<span class="f2">                    cell = [[ChatViewImageCell alloc] initWithIsSender:isSender reuseIdentifier:cellidentifier];</span>
<span class="f2">                }else{</span>
                    cell = [[ChatViewTextCell alloc] initWithIsSender:isSender reuseIdentifier:cellidentifier];
                <span class="f2">}</span>
                break;
            <span class="f2">}</span>
            case MessageBodyType_Voice:
                cell = [[ChatViewVoiceCell alloc] initWithIsSender:isSender reuseIdentifier:cellidentifier];
                break;
<span class="f6">@@ -911,7 +946,7 @@</span> -(void)endOperation{
    userInputState = UserState_None;
    toolbarDisplay = ToolbarDisplay_None;
    if (_isDisplayKeyborad) {
        [self<span class="f1">.view</span> endEditing<span class="f1">:YES</span>];
    } else {
        [self toolbarDisplayChangedToFrameY:viewHeight-_containerView.frame.size.height+ToolbarMoreViewHeight andDuration:0.25];
    }
<span class="f6">@@ -928,6 +963,10 @@</span> -(void)cellHandleLongPress:(UILongPressGestureRecognizer * )longPress{
        id tableviewcell = [self.tableView cellForRowAtIndexPath:indexPath];
        if ([tableviewcell isKindOfClass:[ChatViewCell class]]) {
            ChatViewCell *cell = (ChatViewCell *)tableviewcell;
            <span class="f2">//BQMM集成</span>
<span class="f2">            if (_inputTextView.isFirstResponder) {</span>
<span class="f2">                [self toolbarDisplayChangedToFrameY:viewHeight-_containerView.frame.size.height+ToolbarMoreViewHeight andDuration:0.25];</span>
<span class="f2">            }</span>
            [cell becomeFirstResponder];
            _longPressIndexPath = indexPath;
            [self showMenuViewController:cell.bubbleView message:cell.displayMessage];
<span class="f6">@@ -944,7 +983,18 @@</span> - (void)copyMenuAction:(id)sender {
    if (_longPressIndexPath.row &lt; self.messageArray.count) {
        ECMessage *message = [self.messageArray objectAtIndex:_longPressIndexPath.row];
        ECTextMessageBody *body = (ECTextMessageBody*)message.messageBody;
        <span class="f2">//BQMM集成</span>
<span class="f2">        NSString *extString = message.userData;</span>
<span class="f2">        NSDictionary *extDic = nil;</span>
<span class="f2">        if (extString != nil) {</span>
<span class="f2">            NSData *extData = [extString dataUsingEncoding:NSUTF8StringEncoding];</span>
<span class="f2">            extDic = [NSJSONSerialization JSONObjectWithData:extData options:NSJSONReadingMutableLeaves error:nil];</span>
<span class="f2">        }</span>
<span class="f2">        if (extDic != nil &amp;&amp; [extDic[@&quot;txt_msgType&quot;] isEqualToString:@&quot;emojitype&quot;]) {</span>
<span class="f2">            pasteboard.string = [MMTextParser stringWithExtData:extDic[@&quot;msg_data&quot;]];</span>
<span class="f2">        }else{</span>
            pasteboard.string = body.text;
        <span class="f2">}</span>
    }
    _longPressIndexPath = nil;
}
<span class="f6">@@ -1270,7 +1320,21 @@</span> -(void)voiceCellBubbleViewTap:(ECMessage*)message{
}

-(void)imageCellBubbleViewTap:(ECMessage*)message{
    <span class="f2">//BQMM集成</span>
<span class="f2">    //解析消息扩展</span>
<span class="f2">    NSString *extString = message.userData;</span>
<span class="f2">    NSDictionary *extDic = nil;</span>
<span class="f2">    if (extString != nil) {</span>
<span class="f2">        NSData *extData = [extString dataUsingEncoding:NSUTF8StringEncoding];</span>
<span class="f2">        extDic = [NSJSONSerialization JSONObjectWithData:extData options:NSJSONReadingMutableLeaves error:nil];</span>
<span class="f2">    }</span>
<span class="f2">    if (extDic != nil &amp;&amp; [extDic[@&quot;txt_msgType&quot;] isEqualToString: @&quot;facetype&quot;]) { //大表情消息</span>
<span class="f2">        UIViewController *emojiController = [[MMEmotionCentre defaultCentre] controllerForEmotionCode:extDic[@&quot;msg_data&quot;][0][0]];</span>
<span class="f2">        [self.navigationController pushViewController:emojiController animated:YES];</span>

        <span class="f2">return;</span>
<span class="f2">    }</span>

    if (message.messageBody.messageBodyType &gt;= MessageBodyType_Voice) {
        ECImageMessageBody *mediaBody = (ECImageMessageBody*)message.messageBody;

<span class="f6">@@ -1440,9 +1504,10 @@</span> -(void)createToolBarView {

    //发送语音和变声
    [self createVoiceView];
    <span class="f2">_recordView.hidden = YES;</span>
    //更多的附加功能
    [self createMoreView];
    <span class="f2">_moreView.hidden = YES;</span>
}

-(void)createVoiceView
<span class="f6">@@ -1743,19 +1808,19 @@</span> -(void)toolbarDisplayChangedToFrameY:(CGFloat)frame_y andDuration:(NSTimeInterva

    __weak __typeof(self)weakSelf = self;
    if (toolbarDisplay == ToolbarDisplay_None) {
<span class="f2">//</span>        [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon&quot;] forState:UIControlStateNormal];
<span class="f2">//</span>        [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon_on&quot;] forState:UIControlStateHighlighted];
<span class="f2">//</span>        CGRect frame = _emojiView.frame;
<span class="f2">//</span>        frame.origin.y = self.view.frame.size.height;
<span class="f2">//</span>        _emojiView.frame = frame;
    }

    //如果只显示的toolbar是输入框，表情页消失
<span class="f2">//</span>    if (frame_y == self.view.frame.size.height-_containerView.frame.size.height+ToolbarMoreViewHeight) {
<span class="f2">//</span>        CGRect frame = _emojiView.frame;
<span class="f2">//</span>        frame.origin.y = self.view.frame.size.height;
<span class="f2">//</span>        _emojiView.frame = frame;
<span class="f2">//</span>    }

    void(^animations)() = ^{
        __strong __typeof(weakSelf)strongSelf = weakSelf;
<span class="f6">@@ -1784,96 +1849,92 @@</span> -(void)toolbarDisplayChangedToFrameY:(CGFloat)frame_y andDuration:(NSTimeInterva
    [UIView animateWithDuration:duration delay:0.0f options:(UIViewAnimationOptionCurveEaseIn | UIViewAnimationOptionBeginFromCurrentState) animations:animations completion:completion];
}


/**
 *@brief 根据按钮改变工具栏的显示布局
 */
<span class="f2">//BQMM集成</span>
-(void)switchToolbarDisplay:(id)sender {
<span class="f1">    </span>
    _footView.hidden = _isStartRecord;

    UIButton*button = (UIButton*)sender;

    <span class="f1">//如果上次显示内容为录音，更改显示</span>
<span class="f1">    if (toolbarDisplay == ToolbarDisplay_Record) {</span>
<span class="f1">        _inputView</span><span class="f2">_moreView</span>.hidden = <span class="f1">NO</span><span class="f2">YES</span>;
    <span class="f1">}</span>
<span class="f1">    </span>
<span class="f1">    //如果上次显示内容为表情</span>
<span class="f1">    if (toolbarDisplay == ToolbarDisplay_Emoji) {</span>
<span class="f1">        CGRect frame = _emojiView.frame;</span>
<span class="f1">        frame.origin</span><span class="f2">_recordView</span>.<span class="f1">y</span><span class="f2">hidden</span> = <span class="f1">self.view.frame.size.height</span><span class="f2">YES</span>;
    <span class="f1">_emojiView.frame</span><span class="f2">_changeVoiceView.hidden</span> = <span class="f1">frame</span><span class="f2">YES</span>;<span class="f1">}</span>

<span class="f1">__weak __typeof(self)weakSelf = self;</span>
<span class="f1">    //如果两次按钮的相同触发输入文本</span>    if (<span class="f2">toolbarDisplay ==</span> button.tag<span class="f1">== toolbarDisplay</span>) {
        toolbarDisplay = ToolbarDisplay_None;
        [_inputTextView becomeFirstResponder];
<span class="f1">} else {</span>
<span class="f1">        </span>
<span class="f1">        CGFloat framey = self.view.frame.size.height-ToolbarInputViewHeight;</span>
<span class="f1">        if (button.tag == ToolbarDisplay_More) {</span>
<span class="f1">            //显示出附件功能页面</span>
<span class="f1">            _moreView.hidden = NO;</span>
<span class="f1">            _changeVoiceView.hidden = YES;</span>
<span class="f1">            framey = viewHeight-_containerView.frame.size.height-ToolbarInputViewHeight;</span>
<span class="f1">        } else if (button.tag == ToolbarDisplay_Emoji) {</span>
<span class="f1">            //显示表情页面</span>
<span class="f1">            framey = viewHeight-_containerView.frame.size.height-93.0f;</span>
<span class="f1">            _inputTextView.selectedRange = NSMakeRange(_inputTextView.text.length,0);</span>
<span class="f1">            void(^animations)() = ^{</span>
<span class="f1">                __strong __typeof(weakSelf)strongSelf = weakSelf;</span>
<span class="f1">                if (strongSelf) {</span>
<span class="f1">                    CGRect frame = _emojiView.frame;</span>
<span class="f1">                    frame.origin.y = viewHeight-_emojiView.frame.size.height;</span>
<span class="f1">                    _emojiView.frame=frame;</span>
<span class="f1">                }</span>
<span class="f1">            };</span>

<span class="f1">            [UIView animateWithDuration:0.25 delay:0.1f options:(UIViewAnimationOptionCurveEaseIn | UIViewAnimationOptionBeginFromCurrentState) animations:animations completion:nil];</span>
<span class="f1">            </span>
<span class="f1">        } else if (button.tag == ToolbarDisplay_Record) {</span>
<span class="f1">            //显示录音按钮，并返回默认的布局</span>
<span class="f1">            framey = viewHeight-_containerView.frame.size.height-ToolbarInputViewHeight;</span>
<span class="f1">            _moreView.hidden = YES;</span>
<span class="f1">            _changeVoiceView.hidden = YES;</span>
<span class="f1">            _recordView.hidden = NO;</span>
<span class="f1">        }</span>
<span class="f1">        </span>
<span class="f1">        toolbarDisplay = (ToolbarDisplay)button.tag;</span>
<span class="f1">        </span>
<span class="f1">        if (_isDisplayKeyborad) {</span>
<span class="f1">            //如果显示键盘，在keyboardWillChangeFrame中更改显示</span>
<span class="f1">            [self.view endEditing:YES];</span>
<span class="f1">        } else {</span>
<span class="f1">            //如果未显示键盘，更改显示</span>
<span class="f1">            [self.view endEditing:YES];</span>
<span class="f1">            [self toolbarDisplayChangedToFrameY:framey andDuration:0.25];</span>
<span class="f1">        }</span>
<span class="f1">    }</span>
<span class="f1">    </span>
<span class="f1">    //更换按钮上显示的图片</span>
<span class="f1">    if (toolbarDisplay == ToolbarDisplay_Record) {</span>
<span class="f1">        [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;keyboard_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f1">        [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;keyboard_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f1">        [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f1">        [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f1">    } else if (toolbarDisplay == ToolbarDisplay_Emoji) {</span>
<span class="f1">        [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f1">        [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f1">        [_emojiBtn setImage:[UIImage imageNamed:@&quot;keyboard_icon&quot;] forState:UIControlStateNormal];</span>        [<span class="f1">_emojiBtn setImage:</span>[<span class="f1">UIImage imageNamed:@&quot;keyboard_icon_on&quot;</span><span class="f2">MMEmotionCentre defaultCentre</span>] <span class="f1">forState:UIControlStateHighlighted</span><span class="f2">switchToDefaultKeyboard</span>];<span class="f1">} else {</span>
        [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon&quot;] forState:UIControlStateNormal];
        [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon_on&quot;] forState:UIControlStateHighlighted];
        [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon&quot;] forState:UIControlStateNormal];
        [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon_on&quot;] forState:UIControlStateHighlighted];
    <span class="f2">}else{</span>
<span class="f2">        CGFloat framey = self.view.frame.size.height-ToolbarInputViewHeight;</span>
<span class="f2">        switch (button.tag) {</span>
<span class="f2">            case ToolbarDisplay_More:</span>
<span class="f2">            {</span>
<span class="f2">                [self endEditing];</span>
<span class="f2">                _moreView.hidden = NO;</span>
<span class="f2">                framey = viewHeight-_containerView.frame.size.height-ToolbarInputViewHeight;</span>
<span class="f2">                [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">                [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f2">                [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">                [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f2">                break;</span>
<span class="f2">            }</span>
<span class="f2">                </span>
<span class="f2">            case ToolbarDisplay_Emoji:</span>
<span class="f2">            {</span>
<span class="f2">                [_inputTextView becomeFirstResponder];</span>
<span class="f2">                framey = viewHeight-_containerView.frame.size.height-93.0f-ToolbarInputViewHeight;</span>
<span class="f2">                _inputTextView.selectedRange = NSMakeRange(_inputTextView.text.length,0);</span>
<span class="f2">                [[MMEmotionCentre defaultCentre] attachEmotionKeyboardToInput:_inputTextView.internalTextView];</span>
<span class="f2">                [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">                [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f2">                [_emojiBtn setImage:[UIImage imageNamed:@&quot;keyboard_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">                [_emojiBtn setImage:[UIImage imageNamed:@&quot;keyboard_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f2">                toolbarDisplay = (ToolbarDisplay)button.tag;</span>
<span class="f2">                return; //现在的表情键盘是完全依附在键盘上的，所以布局的逻辑不需要再走</span>
<span class="f2">            }</span>
<span class="f2">                </span>
<span class="f2">            case ToolbarDisplay_Record:</span>
<span class="f2">            {</span>
<span class="f2">                [self endEditing];</span>
<span class="f2">                _recordView.hidden = NO;</span>
<span class="f2">                framey = viewHeight-_containerView.frame.size.height-ToolbarInputViewHeight;</span>
<span class="f2">                [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;keyboard_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">                [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;keyboard_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f2">                [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">                [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f2">                break;</span>
<span class="f2">            }</span>
<span class="f2">            default:</span>
<span class="f2">            {</span>
<span class="f2">                [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">                [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f2">                [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">                [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f2">                break;</span>
<span class="f2">            }</span>
<span class="f2">                </span>
<span class="f2">        }</span>
<span class="f2">        toolbarDisplay = (ToolbarDisplay)button.tag;</span>
<span class="f2">        [self toolbarDisplayChangedToFrameY:framey andDuration:0.25];</span>
    }
}

<span class="f2">//BQMM集成</span>
<span class="f2">-(void)endEditing {</span>
<span class="f2">    [self.view endEditing:YES];</span>
<span class="f2">    toolbarDisplay = ToolbarDisplay_None;</span>
<span class="f2">    [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">    [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f2">    [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">    [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f2">}</span>

#pragma mark - 录音操作

//按下操作
<span class="f6">@@ -2183,6 +2244,7 @@</span> -(void)sendMediaMessage:(ECFileMessageBody*)mediaBody {
/**
 *@brief 发送文本消息
 */
<span class="f2">//BQMM集成</span>
-(void)sendTextMessage {

    userInputState = UserState_None;
<span class="f6">@@ -2192,17 +2254,30 @@</span> -(void)sendTextMessage {

    NSMutableCharacterSet *set = [NSMutableCharacterSet whitespaceCharacterSet];
    [set removeCharactersInString:_deleteAtStr];
    NSString *<span class="f1">textString</span><span class="f2">sendStr = _inputTextView.internalTextView.characterMMText;</span>
<span class="f2">    NSArray *textImgArray</span> =<span class="f1">[</span> _inputTextView.<span class="f1">text stringByTrimmingCharactersInSet</span><span class="f2">internalTextView.textImgArray;</span>
<span class="f2">    NSDictionary *mmExt = @{@&quot;txt_msgType&quot;</span>:<span class="f1">set</span><span class="f2">@&quot;emojitype&quot;,</span>
<span class="f2">                            @&quot;msg_data&quot;:[MMTextParser extDataWithTextImageArray:textImgArray</span>]<span class="f2">};</span>;
    if (<span class="f1">textString</span><span class="f2">sendStr</span>.length == 0) {
        UIAlertView * alert = [[UIAlertView alloc]initWithTitle:nil message:@&quot;不能发送空白消息&quot; delegate:nil cancelButtonTitle:@&quot;确定&quot; otherButtonTitles:nil];
        [alert show];
        return;
    }


    <span class="f2">NSString *extString = nil;</span>
<span class="f2">    if (mmExt) {</span>
<span class="f2">        NSError *parseError = nil;</span>
<span class="f2">        NSData  *extData = [NSJSONSerialization dataWithJSONObject:mmExt</span>
<span class="f2">                                                           options:NSJSONWritingPrettyPrinted error:&amp;parseError];</span>
<span class="f2">        extString = [[NSString alloc] initWithData:extData encoding:NSUTF8StringEncoding];</span>
<span class="f2">        extString = [extString stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceCharacterSet]];</span>
<span class="f2">    }</span>

    ECMessage* message;
    if ([self.sessionId hasPrefix:@&quot;g&quot;] &amp;&amp; [<span class="f1">textString</span><span class="f2">sendStr</span> myContainsString:_deleteAtStr]) {
        NSMutableArray *personArray = [DemoGlobalClass sharedInstance].AtPersonArray;
        NSArray *array = [<span class="f1">textString</span><span class="f2">sendStr</span> componentsSeparatedByCharactersInSet:[NSCharacterSet characterSetWithCharactersInString:[NSString stringWithFormat:@&quot;@%@&quot;,_deleteAtStr]]];
        for (NSString *str in array) {
            NSArray *bookArray = [DemoGlobalClass sharedInstance].groupMemberArray;
            for (AddressBook *book in bookArray) {
<span class="f6">@@ -2213,15 +2288,37 @@</span> -(void)sendTextMessage {
                }
            }
        }
        message = [[DeviceChatHelper sharedInstance] sendTextMessage:<span class="f1">textString</span><span class="f2">sendStr</span> to:self.sessionId withUserData:<span class="f1">nil</span><span class="f2">extString</span> atArray:personArray];
    } else {
        message = [[DeviceChatHelper sharedInstance] sendTextMessage:<span class="f1">textString</span><span class="f2">sendStr</span> to:self.sessionId <span class="f2">withUserData:extString atArray:nil</span>];
    }
    [[DemoGlobalClass sharedInstance].AtPersonArray removeAllObjects];
    [[NSNotificationCenter defaultCenter] postNotificationName:KNOTIFICATION_onMesssageChanged object:message];
}

/**
 <span class="f2">*@brief 发送大表情消息</span>
<span class="f2"> */</span>
<span class="f2">-(void)sendMMFace:(MMEmoji *)emoji {</span>
<span class="f2">    NSDictionary *mmExt = @{@&quot;txt_msgType&quot;:@&quot;facetype&quot;,</span>
<span class="f2">                            @&quot;msg_data&quot;:@[@[emoji.emojiCode, [NSString stringWithFormat:@&quot;%d&quot;, emoji.isEmoji ? 1 : 2]]]};</span>
<span class="f2">    NSString *extString = nil;</span>
<span class="f2">    if (mmExt) {</span>
<span class="f2">        NSError *parseError = nil;</span>
<span class="f2">        NSData  *extData = [NSJSONSerialization dataWithJSONObject:mmExt</span>
<span class="f2">                                                           options:NSJSONWritingPrettyPrinted error:&amp;parseError];</span>
<span class="f2">        extString = [[NSString alloc] initWithData:extData encoding:NSUTF8StringEncoding];</span>
<span class="f2">        extString = [extString stringByTrimmingCharactersInSet:[NSCharacterSet whitespaceCharacterSet]];</span>
<span class="f2">    }</span>
<span class="f2">    </span>
<span class="f2">    NSString *sendStr = [NSString stringWithFormat:@&quot;[%@]&quot;, emoji.emojiName];</span>
<span class="f2">    ECMessage* message;</span>
<span class="f2">    message = [[DeviceChatHelper sharedInstance] sendTextMessage:sendStr to:self.sessionId withUserData:extString atArray:nil];</span>
<span class="f2">    [[DemoGlobalClass sharedInstance].AtPersonArray removeAllObjects];</span>
<span class="f2">    [[NSNotificationCenter defaultCenter] postNotificationName:KNOTIFICATION_onMesssageChanged object:message];</span>
<span class="f2">}</span>

<span class="f2">/**</span>
 *@brief 发送成功，消息状态更新
 */
-(void)sendMessageCompletion:(NSNotification*)notification {
<span class="f6">@@ -2672,6 +2769,13 @@</span> - (void)growingTextViewDidChangeSelection:(HPGrowingTextView *)growingTextView {
    }
}

<span class="f2">//BQMM集成</span>
<span class="f2">- (void)growingTextViewDidChange:(HPGrowingTextView *)growingTextView {</span>
<span class="f2">    </span>
<span class="f2">//    [self willShowInputTextViewToHeight:[self getTextViewContentH:textView]];</span>

<span class="f2">}</span>

#pragma mark - ECLocationViewControllerDelegate
- (void)onSendUserLocation:(ECLocationPoint *)point {

<span class="f6">@@ -2760,4 +2864,32 @@</span> - (void) notifyUserState:(NSNotification*)notification {
        }
    }
}

<span class="f2">//BQMM集成</span>
<span class="f2">#pragma mark - MMEmotionCentreDelegate</span>
<span class="f2">- (void)didSelectEmoji:(MMEmoji *)emoji</span>
<span class="f2">{</span>
<span class="f2">    [self sendMMFace:emoji];</span>
<span class="f2">}</span>

<span class="f2">- (void)didSelectTipEmoji:(MMEmoji *)emoji</span>
<span class="f2">{</span>
<span class="f2">    [self sendMMFace:emoji];</span>
<span class="f2">    _inputTextView.text = @&quot;&quot;;</span>
<span class="f2">}</span>

<span class="f2">- (void)didSendWithInput:(UIResponder&lt;UITextInput&gt; *)input</span>
<span class="f2">{</span>
<span class="f2">    [self sendTextMessage];</span>
<span class="f2">    _inputTextView.text = @&quot;&quot;;</span>
<span class="f2">}</span>

<span class="f2">- (void)tapOverlay</span>
<span class="f2">{</span>
<span class="f2">    [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">    [_switchVoiceBtn setImage:[UIImage imageNamed:@&quot;voice_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f2">    [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon&quot;] forState:UIControlStateNormal];</span>
<span class="f2">    [_emojiBtn setImage:[UIImage imageNamed:@&quot;facial_expression_icon_on&quot;] forState:UIControlStateHighlighted];</span>
<span class="f2">}</span>

@end
<span class="bold">diff --git a/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/LoginAndMain/MainViewController.m b/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/LoginAndMain/MainViewController.m</span>
<span class="bold">index 4934930..74d4b2d 100755</span>
<span class="bold">--- a/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/LoginAndMain/MainViewController.m</span>
<span class="bold">+++ b/ECSDKDemo_OC/ECSDKDemo_OC/Class/View/LoginAndMain/MainViewController.m</span>
<span class="f6">@@ -41,7 +41,7 @@</span> - (void)viewDidLoad {
    [super viewDidLoad];

    [[UIApplication sharedApplication] setStatusBarStyle:UIStatusBarStyleLightContent];
    self.navigationController.navigationBar.tintColor = [UIColor <span class="f1">redColor</span><span class="f2">whiteColor</span>];  <span class="f2">//BQMM集成</span>

    [self completionSyncHistory];

<span class="bold">diff --git a/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextParser+ExtData.h b/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextParser+ExtData.h</span>
<span class="bold">deleted file mode 100644</span>
<span class="bold">index 8bef103..0000000</span>
<span class="bold">--- a/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextParser+ExtData.h</span>
<span class="bold">+++ /dev/null</span>
<span class="f6">@@ -1,67 +0,0 @@</span>
<span class="f1">//</span>
<span class="f1">//  MMTextParser+ExtData.h</span>
<span class="f1">//  ChatDemo-UI2.0</span>
<span class="f1">//</span>
<span class="f1">//  Created by LiChao Jun on 16/1/23.</span>
<span class="f1">//  Copyright © 2016 LiChao Jun. All rights reserved.</span>
<span class="f1">//</span>

<span class="f1">#import &lt;Foundation/Foundation.h&gt;</span>
<span class="f1">#import &lt;BQMM/BQMM.h&gt;</span>

<span class="f1">@interface MMTextParser (ExtData)</span>

<span class="f1">/**</span>
<span class="f1"> *  convert textImageArray to extData</span>
<span class="f1"> *</span>
<span class="f1"> *  @param textImageArray    a collection of MMEmoji and text</span>
<span class="f1"> *</span>
<span class="f1"> *  @return extData          a two dimentional array e.g. @[@[@&quot;emojiCode&quot;, @1], @[@&quot;text&quot;, @0]]</span>
<span class="f1"> */</span>
<span class="f1">+ (NSArray*)extDataWithTextImageArray:(NSArray*)textImageArray;</span>

<span class="f1">/**</span>
<span class="f1"> *  convert a single emojiCode to extData</span>
<span class="f1"> *</span>
<span class="f1"> *  @param emojiCode         the emoji code</span>
<span class="f1"> *</span>
<span class="f1"> *  @return extData          a two dimentional array e.g. @[@[@&quot;emojiCode&quot;, @1], @[@&quot;text&quot;, @0]]</span>
<span class="f1"> */</span>
<span class="f1">+ (NSArray*)extDataWithEmojiCode:(NSString*)emojiCode;</span>

<span class="f1">/**</span>
<span class="f1"> *  convert extData to mmtext</span>
<span class="f1"> *</span>
<span class="f1"> *  @param extData           a two dimentional array e.g. @[@[@&quot;emojiCode&quot;, @1], @[@&quot;text&quot;, @0]]</span>
<span class="f1"> *</span>
<span class="f1"> *  @return mmtext</span>
<span class="f1"> */</span>
<span class="f1">+ (NSString*)stringWithExtData:(NSArray*)extData;</span>

<span class="f1">/**</span>
<span class="f1"> *  compute the size of MMTextView, `extData` is MMTextView's content</span>
<span class="f1"> *</span>
<span class="f1"> *  @param extData           a two dimentional array e.g. @[@[@&quot;emojiCode&quot;, @1], @[@&quot;text&quot;, @0]]</span>
<span class="f1"> *  @param font              the font of MMTextView</span>
<span class="f1"> *  @param maximumTextWidth  the max width set to MMTextView</span>
<span class="f1"> *</span>
<span class="f1"> *  @return the size of content in MMTextView</span>
<span class="f1"> */</span>
<span class="f1">+ (CGSize)sizeForMMTextWithExtData:(NSArray*)extData</span>
<span class="f1">                              font:(UIFont *)font</span>
<span class="f1">                  maximumTextWidth:(CGFloat)maximumTextWidth;</span>

<span class="f1">/**</span>
<span class="f1"> *  compute the size of MMTextView, `text` is MMTextView's content</span>
<span class="f1"> *</span>
<span class="f1"> *  @param extData           a two dimentional array e.g. @[@[@&quot;emojiCode&quot;, @1], @[@&quot;text&quot;, @0]]</span>
<span class="f1"> *  @param font              the font of MMTextView</span>
<span class="f1"> *  @param maximumTextWidth  the max width set to MMTextView</span>
<span class="f1"> *</span>
<span class="f1"> *  @return the size of content in MMTextView</span>
<span class="f1"> */</span>
<span class="f1">+ (CGSize)sizeForTextWithText:(NSString *)text</span>
<span class="f1">                         font:(UIFont *)font</span>
<span class="f1">             maximumTextWidth:(CGFloat)maximumTextWidth;</span>

<span class="f1">@end</span>
<span class="bold">diff --git a/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextParser+ExtData.m b/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextParser+ExtData.m</span>
<span class="bold">deleted file mode 100644</span>
<span class="bold">index 1359a4e..0000000</span>
<span class="bold">--- a/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextParser+ExtData.m</span>
<span class="bold">+++ /dev/null</span>
<span class="f6">@@ -1,108 +0,0 @@</span>
<span class="f1">//</span>
<span class="f1">//  MMTextParser+ExtData.m</span>
<span class="f1">//  ChatDemo-UI2.0</span>
<span class="f1">//</span>
<span class="f1">//  Created by LiChao Jun on 16/1/23.</span>
<span class="f1">//  Copyright © 2016年 LiChao Jun. All rights reserved.</span>
<span class="f1">//</span>

<span class="f1">#import &quot;MMTextParser+ExtData.h&quot;</span>

<span class="f1">static MMEmoji *s_placeholderEmoji = nil;</span>

<span class="f1">@implementation MMTextParser (ExtData)</span>

<span class="f1">+ (NSArray*)extDataWithTextImageArray:(NSArray*)textImageArray {</span>
<span class="f1">    NSMutableArray *ret = [NSMutableArray array];</span>
<span class="f1">    </span>
<span class="f1">    for (id obj in textImageArray) {</span>
<span class="f1">        if ([obj isKindOfClass:[MMEmoji class]]) {</span>
<span class="f1">            MMEmoji *emoji = (MMEmoji*)obj;</span>
<span class="f1">            [ret addObject:@[emoji.emojiCode, [NSString stringWithFormat:@&quot;%d&quot;, [MMTextParser emojiTypeWithEmojiCode:emoji.emojiCode]]]];</span>
<span class="f1">        } else if ([obj isKindOfClass:[NSString class]]) {</span>
<span class="f1">            [ret addObject:@[obj, [NSString stringWithFormat:@&quot;%d&quot;, EmojiTypeInvalid]]];</span>
<span class="f1">        } else {</span>
<span class="f1">            assert(0);</span>
<span class="f1">        }</span>
<span class="f1">    }</span>
<span class="f1">    </span>
<span class="f1">    return ret;</span>
<span class="f1">}</span>

<span class="f1">+ (NSArray*)extDataWithEmojiCode:(NSString*)emojiCode {</span>
<span class="f1">    </span>
<span class="f1">    return @[@[emojiCode, [NSString stringWithFormat:@&quot;%d&quot;, [MMTextParser emojiTypeWithEmojiCode:emojiCode]]]];</span>
<span class="f1">}</span>

<span class="f1">+ (NSString*)stringWithExtData:(NSArray*)extData {</span>
<span class="f1">    NSString *ret = @&quot;&quot;;</span>
<span class="f1">    for (NSArray *obj in extData) {</span>
<span class="f1">        NSString *str = obj[0];</span>
<span class="f1">        BOOL isEmojiCode = [obj[1] boolValue];</span>
<span class="f1">        if (isEmojiCode) {</span>
<span class="f1">            ret = [ret stringByAppendingString:[NSString stringWithFormat:@&quot;[%@]&quot;, str]];</span>
<span class="f1">        } else {</span>
<span class="f1">            ret = [ret stringByAppendingString:str];</span>
<span class="f1">        }</span>
<span class="f1">    }</span>
<span class="f1">    return ret;</span>
<span class="f1">}</span>

<span class="f1">+ (CGSize)sizeForMMTextWithExtData:(NSArray*)extData</span>
<span class="f1">                              font:(UIFont *)font</span>
<span class="f1">                  maximumTextWidth:(CGFloat)maximumTextWidth {</span>
<span class="f1">    NSMutableAttributedString *attrStr = [[NSMutableAttributedString alloc] init];</span>
<span class="f1">    for (NSArray *obj in extData) {</span>
<span class="f1">        NSString *str = obj[0];</span>
<span class="f1">        EmojiType type = [obj[1] intValue];</span>
<span class="f1">        switch (type) {</span>
<span class="f1">            case EmojiTypeInvalid:</span>
<span class="f1">            {</span>
<span class="f1">                [attrStr appendAttributedString:[[NSAttributedString alloc] initWithString:str]];</span>
<span class="f1">            }</span>
<span class="f1">                break;</span>
<span class="f1">                </span>
<span class="f1">            case EmojiTypeSmall:</span>
<span class="f1">            {</span>
<span class="f1">                NSTextAttachment *placeholderAttachment = [[NSTextAttachment alloc] init];</span>
<span class="f1">                placeholderAttachment.bounds = CGRectMake(0, 0, 20, 20);//fixed size: 20X20</span>
<span class="f1">                [attrStr appendAttributedString:[NSAttributedString attributedStringWithAttachment:placeholderAttachment]];</span>
<span class="f1">            }</span>
<span class="f1">                break;</span>
<span class="f1">                </span>
<span class="f1">            case EmojiTypeBig:</span>
<span class="f1">            {</span>
<span class="f1">                NSTextAttachment *placeholderAttachment = [[NSTextAttachment alloc] init];</span>
<span class="f1">                placeholderAttachment.bounds = CGRectMake(0, 0, 60, 60);//fixed size: 60X60</span>
<span class="f1">                [attrStr appendAttributedString:[NSAttributedString attributedStringWithAttachment:placeholderAttachment]];</span>
<span class="f1">            }</span>
<span class="f1">                break;</span>
<span class="f1">                </span>
<span class="f1">            default:</span>
<span class="f1">                break;</span>
<span class="f1">        }</span>
<span class="f1">    }</span>
<span class="f1">    </span>
<span class="f1">    if (font) {</span>
<span class="f1">        [attrStr addAttribute:NSFontAttributeName value:font range:NSMakeRange(0, attrStr.length)];</span>
<span class="f1">    }</span>
<span class="f1">    </span>
<span class="f1">    CGSize sizeToFit = [attrStr boundingRectWithSize:CGSizeMake(maximumTextWidth, MAXFLOAT)</span>
<span class="f1">                                             options:NSStringDrawingUsesLineFragmentOrigin|NSStringDrawingUsesFontLeading</span>
<span class="f1">                                             context:nil].size;</span>
<span class="f1">    </span>
<span class="f1">    return CGRectIntegral(CGRectMake(0, 0, sizeToFit.width + 10, sizeToFit.height + 16)).size;</span>
<span class="f1">}</span>

<span class="f1">+ (CGSize)sizeForTextWithText:(NSString *)text</span>
<span class="f1">                         font:(UIFont *)font</span>
<span class="f1">             maximumTextWidth:(CGFloat)maximumTextWidth {</span>
<span class="f1">    CGSize size = CGSizeZero;</span>
<span class="f1">    size = [text boundingRectWithSize:CGSizeMake(maximumTextWidth, CGFLOAT_MAX) options:NSStringDrawingUsesLineFragmentOrigin|NSStringDrawingUsesFontLeading attributes:@{NSFontAttributeName:font} context:nil].size;</span>
<span class="f1">    size.width += 10;</span>
<span class="f1">    size.height += 16;</span>
<span class="f1">    </span>
<span class="f1">    return size;</span>
<span class="f1">}</span>

<span class="f1">@end</span>
<span class="bold">diff --git a/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextParser.h b/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextParser.h</span>
<span class="bold">new file mode 100644</span>
<span class="bold">index 0000000..443ae77</span>
<span class="bold">--- /dev/null</span>
<span class="bold">+++ b/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextParser.h</span>
<span class="f6">@@ -0,0 +1,77 @@</span>
<span class="f2">//</span>
<span class="f2">//  MMTextParser.h</span>
<span class="f2">//  BQMM SDK</span>
<span class="f2">//</span>
<span class="f2">//  Created by ceo on 12/28/15.</span>
<span class="f2">//  Copyright © 2015 siyanhui. All rights reserved.</span>
<span class="f2">//</span>

<span class="f2">#import &lt;Foundation/Foundation.h&gt;</span>
<span class="f2">#import &lt;BQMM/BQMM.h&gt;</span>
<span class="f2">typedef enum</span>
<span class="f2">{</span>
<span class="f2">    EmojiTypeInvalid = 0,</span>
<span class="f2">    EmojiTypeSmall,</span>
<span class="f2">    EmojiTypeBig</span>
<span class="f2">} EmojiType;</span>

<span class="f2">@interface MMTextParser : NSObject</span>

<span class="f2">/**</span>
<span class="f2"> *  convert textImageArray to extData</span>
<span class="f2"> *</span>
<span class="f2"> *  @param textImageArray    a collection of MMEmoji and text</span>
<span class="f2"> *</span>
<span class="f2"> *  @return extData          a two dimentional array e.g. @[@[@&quot;emojiCode&quot;, @1], @[@&quot;text&quot;, @0]]</span>
<span class="f2"> */</span>
<span class="f2">+ (nonnull NSArray*)extDataWithTextImageArray:(nonnull NSArray* )textImageArray;</span>

<span class="f2">+ (nonnull NSArray * )extDataWithEmoji:(nonnull MMEmoji *)emoji;</span>

<span class="f2">/**</span>
<span class="f2"> *  convert extData to mmtext</span>
<span class="f2"> *</span>
<span class="f2"> *  @param extData           a two dimentional array e.g. @[@[@&quot;emojiCode&quot;, @1], @[@&quot;text&quot;, @0]]</span>
<span class="f2"> *</span>
<span class="f2"> *  @return mmtext</span>
<span class="f2"> */</span>
<span class="f2">+ (nonnull NSString*)stringWithExtData:(nonnull NSArray*)extData;</span>

<span class="f2">/**</span>
<span class="f2"> *  compute the size of MMTextView, `extData` is MMTextView's content</span>
<span class="f2"> *</span>
<span class="f2"> *  @param extData           a two dimentional array e.g. @[@[@&quot;emojiCode&quot;, @1], @[@&quot;text&quot;, @0]]</span>
<span class="f2"> *  @param font              the font of MMTextView</span>
<span class="f2"> *  @param maximumTextWidth  the max width set to MMTextView</span>
<span class="f2"> *</span>
<span class="f2"> *  @return the size of content in MMTextView</span>
<span class="f2"> */</span>
<span class="f2">+ (CGSize)sizeForMMTextWithExtData:(nonnull NSArray*)extData</span>
<span class="f2">                              font:(nonnull UIFont *)font</span>
<span class="f2">                  maximumTextWidth:(CGFloat)maximumTextWidth;</span>

<span class="f2">/**</span>
<span class="f2"> *  compute the size of MMTextView, `text` is MMTextView's content</span>
<span class="f2"> *</span>
<span class="f2"> *  @param extData           a two dimentional array e.g. @[@[@&quot;emojiCode&quot;, @1], @[@&quot;text&quot;, @0]]</span>
<span class="f2"> *  @param font              the font of MMTextView</span>
<span class="f2"> *  @param maximumTextWidth  the max width set to MMTextView</span>
<span class="f2"> *</span>
<span class="f2"> *  @return the size of content in MMTextView</span>
<span class="f2"> */</span>
<span class="f2">+ (CGSize)sizeForTextWithText:(nonnull NSString *)text</span>
<span class="f2">                         font:(nonnull UIFont *)font</span>
<span class="f2">             maximumTextWidth:(CGFloat)maximumTextWidth;</span>



<span class="f2">/**</span>
<span class="f2"> *  check the emoji to find out emoji type</span>
<span class="f2"> *</span>
<span class="f2"> *  @param emoji        emoji</span>
<span class="f2"> *</span>
<span class="f2"> *  @return             EmojiType</span>
<span class="f2"> */</span>
<span class="f2">+ (EmojiType)emojiTypeWithEmoji:(nullable MMEmoji *)emoji;</span>

<span class="f2">@end</span>
<span class="bold">diff --git a/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextParser.m b/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextParser.m</span>
<span class="bold">new file mode 100644</span>
<span class="bold">index 0000000..64cfd28</span>
<span class="bold">--- /dev/null</span>
<span class="bold">+++ b/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextParser.m</span>
<span class="f6">@@ -0,0 +1,113 @@</span>
<span class="f2">//</span>
<span class="f2">//  MMTextParser.m</span>
<span class="f2">//  StampMeSDK</span>
<span class="f2">//</span>
<span class="f2">//  Created by ceo on 12/28/15.</span>
<span class="f2">//  Copyright © 2015 siyanhui. All rights reserved.</span>
<span class="f2">//</span>

<span class="f2">#import &quot;MMTextParser.h&quot;</span>

<span class="f2">@implementation MMTextParser</span>

<span class="f2">+ (NSArray*)extDataWithTextImageArray:(NSArray*)textImageArray {</span>
<span class="f2">    NSMutableArray *ret = [NSMutableArray array];</span>
<span class="f2">    </span>
<span class="f2">    for (id obj in textImageArray) {</span>
<span class="f2">        if ([obj isKindOfClass:[MMEmoji class]]) {</span>
<span class="f2">            MMEmoji *emoji = (MMEmoji*)obj;</span>
<span class="f2">            [ret addObject:@[emoji.emojiCode, [NSString stringWithFormat:@&quot;%d&quot;, [MMTextParser emojiTypeWithEmoji:emoji]]]];</span>
<span class="f2">        } else if ([obj isKindOfClass:[NSString class]]) {</span>
<span class="f2">            [ret addObject:@[obj, [NSString stringWithFormat:@&quot;%d&quot;, EmojiTypeInvalid]]];</span>
<span class="f2">        } else {</span>
<span class="f2">            assert(0);</span>
<span class="f2">        }</span>
<span class="f2">    }</span>
<span class="f2">    </span>
<span class="f2">    return ret;</span>
<span class="f2">}</span>

<span class="f2">+ (NSArray *)extDataWithEmoji:(MMEmoji *)emoji {</span>
<span class="f2">    return @[@[emoji.emojiCode, [NSString stringWithFormat:@&quot;%d&quot;, [MMTextParser emojiTypeWithEmoji:emoji]]]];</span>
<span class="f2">}</span>

<span class="f2">+ (NSString*)stringWithExtData:(NSArray*)extData {</span>
<span class="f2">    NSString *ret = @&quot;&quot;;</span>
<span class="f2">    for (NSArray *obj in extData) {</span>
<span class="f2">        NSString *str = obj[0];</span>
<span class="f2">        BOOL isEmojiCode = [obj[1] boolValue];</span>
<span class="f2">        if (isEmojiCode) {</span>
<span class="f2">            ret = [ret stringByAppendingString:[NSString stringWithFormat:@&quot;[%@]&quot;, str]];</span>
<span class="f2">        } else {</span>
<span class="f2">            ret = [ret stringByAppendingString:str];</span>
<span class="f2">        }</span>
<span class="f2">    }</span>
<span class="f2">    return ret;</span>
<span class="f2">}</span>

<span class="f2">+ (CGSize)sizeForMMTextWithExtData:(NSArray*)extData</span>
<span class="f2">                              font:(UIFont *)font</span>
<span class="f2">                  maximumTextWidth:(CGFloat)maximumTextWidth {</span>
<span class="f2">    NSMutableAttributedString *attrStr = [[NSMutableAttributedString alloc] init];</span>
<span class="f2">    for (NSArray *obj in extData) {</span>
<span class="f2">        NSString *str = obj[0];</span>
<span class="f2">        EmojiType type = [obj[1] intValue];</span>
<span class="f2">        switch (type) {</span>
<span class="f2">            case EmojiTypeInvalid:</span>
<span class="f2">            {</span>
<span class="f2">                [attrStr appendAttributedString:[[NSAttributedString alloc] initWithString:str]];</span>
<span class="f2">            }</span>
<span class="f2">                break;</span>
<span class="f2">                </span>
<span class="f2">            case EmojiTypeSmall:</span>
<span class="f2">            {</span>
<span class="f2">                NSTextAttachment *placeholderAttachment = [[NSTextAttachment alloc] init];</span>
<span class="f2">                placeholderAttachment.bounds = CGRectMake(0, 0, 20, 20);//fixed size: 20X20</span>
<span class="f2">                [attrStr appendAttributedString:[NSAttributedString attributedStringWithAttachment:placeholderAttachment]];</span>
<span class="f2">            }</span>
<span class="f2">                break;</span>
<span class="f2">                </span>
<span class="f2">            case EmojiTypeBig:</span>
<span class="f2">            {</span>
<span class="f2">                NSTextAttachment *placeholderAttachment = [[NSTextAttachment alloc] init];</span>
<span class="f2">                placeholderAttachment.bounds = CGRectMake(0, 0, 60, 60);//fixed size: 60X60</span>
<span class="f2">                [attrStr appendAttributedString:[NSAttributedString attributedStringWithAttachment:placeholderAttachment]];</span>
<span class="f2">            }</span>
<span class="f2">                break;</span>
<span class="f2">                </span>
<span class="f2">            default:</span>
<span class="f2">                break;</span>
<span class="f2">        }</span>
<span class="f2">    }</span>
<span class="f2">    </span>
<span class="f2">    if (font) {</span>
<span class="f2">        [attrStr addAttribute:NSFontAttributeName value:font range:NSMakeRange(0, attrStr.length)];</span>
<span class="f2">    }</span>
<span class="f2">    </span>
<span class="f2">    CGSize sizeToFit = [attrStr boundingRectWithSize:CGSizeMake(maximumTextWidth, MAXFLOAT)</span>
<span class="f2">                                             options:NSStringDrawingUsesLineFragmentOrigin|NSStringDrawingUsesFontLeading</span>
<span class="f2">                                             context:nil].size;</span>
<span class="f2">    </span>
<span class="f2">    return CGRectIntegral(CGRectMake(0, 0, sizeToFit.width + 10, sizeToFit.height + 16)).size;</span>
<span class="f2">}</span>

<span class="f2">+ (CGSize)sizeForTextWithText:(NSString *)text</span>
<span class="f2">                         font:(UIFont *)font</span>
<span class="f2">             maximumTextWidth:(CGFloat)maximumTextWidth {</span>
<span class="f2">    CGSize size = CGSizeZero;</span>
<span class="f2">    size = [text boundingRectWithSize:CGSizeMake(maximumTextWidth, CGFLOAT_MAX) options:NSStringDrawingUsesLineFragmentOrigin|NSStringDrawingUsesFontLeading attributes:@{NSFontAttributeName:font} context:nil].size;</span>
<span class="f2">    size.width += 10;</span>
<span class="f2">    size.height += 16;</span>
<span class="f2">    </span>
<span class="f2">    return size;</span>
<span class="f2">}</span>

<span class="f2">+ (EmojiType)emojiTypeWithEmoji:(MMEmoji*)emoji {</span>
<span class="f2">    if(emoji.isEmoji) {</span>
<span class="f2">        return EmojiTypeSmall;</span>
<span class="f2">    }else{</span>
<span class="f2">        return EmojiTypeBig;</span>
<span class="f2">    }</span>
<span class="f2">}</span>

<span class="f2">@end</span>
<span class="bold">diff --git a/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextView.m b/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextView.m</span>
<span class="bold">index 2530fa1..b50bdae 100644</span>
<span class="bold">--- a/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextView.m</span>
<span class="bold">+++ b/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/BQMM_SDK/BQMM_EXT/MMTextView.m</span>
<span class="f6">@@ -8,7 +8,7 @@</span>
#include &lt;CoreText/CoreText.h&gt;
#import &quot;MMTextView.h&quot;
#import &lt;BQMM/BQMM.h&gt;
#import &quot;MMTextParser<span class="f1">+ExtData</span>.h&quot;
#import &quot;MMTextAttachment.h&quot;

@interface MMDataDetector : NSDataDetector
<span class="f6">@@ -33,6 +33,7 @@</span> @interface MMTextView () {
@property (nonatomic, strong) NSMutableArray *attachmentRanges;
@property (nonatomic, strong) NSMutableArray *attachments;
@property (nonatomic, strong) NSMutableArray *imageViews;
<span class="f2">@property (nonatomic, assign) NSInteger task;</span>

@end

<span class="f6">@@ -42,6 +43,7 @@</span> - (id)initWithFrame:(CGRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
        _disableActionMenu = NO;
        <span class="f2">_task = 0;</span>
    }
    return self;
}
<span class="f6">@@ -108,39 +110,201 @@</span> - (void)setPlaceholderTextWithData:(NSArray*)extData {
    self.attributedText = mAStr;
}

<span class="f2">- (void)setText:(NSString *)text {</span>
<span class="f2">    [self clearImageViewsCover];</span>
<span class="f2">    self.task++;</span>
<span class="f2">    [super setText:text];</span>
<span class="f2">}</span>

<span class="f2">//- (void)setMmText:(NSString *)mmText {//这个不需要吧</span>
<span class="f2">//    self.task++;</span>
<span class="f2">//    self.text = mmText;</span>
<span class="f2">//</span>
<span class="f2">//}</span>

- (void)setMmTextData:(NSArray *)extData {
    <span class="f2">self.task++;</span>
    [self setMmTextData:extData completionHandler:nil];
}

- (void)setMmTextData:(NSArray*)extData completionHandler:(void(^)(void))completionHandler {
    [self setPlaceholderTextWithData:extData];
    <span class="f1">[</span><span class="f2">__weak MMTextView* weakSelf =</span> self<span class="f1">updateAttributeTextWithData:extData completionHandler:completionHandler]</span>;
    [self clearImageViewsCover];
    [self <span class="f2">updateAttributeTextWithData:extData completionHandler:^{</span>
<span class="f2">        [weakSelf</span>.attributedText enumerateAttribute:NSAttachmentAttributeName
                                        inRange:NSMakeRange(0, [self.attributedText length])
                                        options:0
                                     usingBlock:^(id value, NSRange range, BOOL * stop) {<span class="f1">if ([value isKindOfClass:[MMTextAttachment class]]) {</span>
                                         if ([value isKindOfClass:[MMTextAttachment class]]) {
                                             MMTextAttachment *attachment = (MMTextAttachment *)value;
                                             [<span class="f1">self</span><span class="f2">weakSelf</span>.attachmentRanges addObject:[NSValue valueWithRange:range]];
                                             [<span class="f1">self</span><span class="f2">weakSelf</span>.attachments addObject:value];
                                             UIImageView *imgView = [[UIImageView alloc] initWithImage:attachment.emoji.emojiImage];
                                             attachment.image = nil;
                                             [<span class="f1">self</span><span class="f2">weakSelf</span>.imageViews addObject:imgView];
                                         }
                                     }<span class="f2">];</span>
<span class="f2">        [weakSelf setNeedsLayout];</span>

<span class="f2">        if (completionHandler) {</span>
<span class="f2">            completionHandler();</span>
<span class="f2">        }</span>
<span class="f2">    }];</span>
<span class="f2">}</span>

<span class="f2">#pragma mark - private</span>

<span class="f2">- (void)updateAttributeTextWithData:(NSArray*)extData completionHandler:(void(^)(void))completionHandler {</span>
<span class="f2">    NSMutableArray *codes = [NSMutableArray array];</span>
<span class="f2">    __block NSMutableArray *textImgArray = [NSMutableArray array];</span>
<span class="f2">    for (NSArray *obj in extData) {</span>
<span class="f2">        NSString *str = obj[0];</span>
<span class="f2">        BOOL isEmoji = [obj[1] integerValue] == 0 ? NO : YES;</span>
<span class="f2">        if (isEmoji) {</span>
<span class="f2">            if (![codes containsObject:str]) {</span>
<span class="f2">                [codes addObject:str];</span>
<span class="f2">            }</span>
<span class="f2">        }</span>
<span class="f2">        [textImgArray addObject:str];</span>
<span class="f2">    }</span>

<span class="f2">    __block NSInteger task = _task;</span>
<span class="f2">    __weak MMTextView *weakSelf = self;</span>
<span class="f2">    [[MMEmotionCentre defaultCentre] fetchEmojisByType:MMFetchTypeAll codes:codes completionHandler:^(NSArray *emojis) {</span>
<span class="f2">        __strong MMTextView *tempSelf = weakSelf;</span>
<span class="f2">        if (!weakSelf) {</span>
<span class="f2">            return;</span>
<span class="f2">        }</span>
<span class="f2">        if (task != tempSelf.task) {</span>
<span class="f2">            return;</span>
<span class="f2">        }</span>

<span class="f2">        NSMutableAttributedString *mAStr = [[NSMutableAttributedString alloc] init];</span>
<span class="f2">        for (MMEmoji *emoji in emojis) {</span>
<span class="f2">            NSInteger objIndex = [textImgArray indexOfObject:emoji.emojiCode];</span>
<span class="f2">            while (objIndex != NSNotFound) {</span>
<span class="f2">                [textImgArray replaceObjectAtIndex:objIndex withObject:emoji];</span>
<span class="f2">                objIndex = [textImgArray indexOfObject:emoji.emojiCode];</span>
<span class="f2">            }</span>
        }
        <span class="f2">for (id obj in textImgArray) {</span>
<span class="f2">            if ([obj isKindOfClass:[MMEmoji class]]) {</span>
<span class="f2">                MMTextAttachment *attachment = [[MMTextAttachment alloc] init</span>];
                <span class="f2">attachment.emoji = obj;</span>
<span class="f2">                if ([attachment.image.images count] &gt; 1) {</span>
<span class="f2">                    attachment.image = [attachment placeHolderImage];</span>
<span class="f2">                }</span>
<span class="f2">                [mAStr appendAttributedString:[NSAttributedString attributedStringWithAttachment:attachment]];</span>
<span class="f2">            } else {</span>
<span class="f2">                [mAStr appendAttributedString:[[NSAttributedString alloc] initWithString:obj]];</span>
<span class="f2">            }</span>
<span class="f2">        }</span>
<span class="f2">        if (weakSelf.mmFont) {</span>
<span class="f2">            [mAStr addAttribute:NSFontAttributeName value:weakSelf.mmFont range:NSMakeRange(0, mAStr.length)];</span>
<span class="f2">        }</span>
<span class="f2">        if (weakSelf.mmTextColor) {</span>
<span class="f2">            [mAStr addAttribute:NSForegroundColorAttributeName value:weakSelf.mmTextColor range:NSMakeRange(0, mAStr.length)];</span>
<span class="f2">        }</span>
<span class="f2">        weakSelf.attributedText = mAStr;</span>
<span class="f2">        //search the content of MMtextView for URL and Phone number and set `link attribute` on them</span>
<span class="f2">        [weakSelf setURLAttributes];</span>
<span class="f2">        if (completionHandler) {</span>
<span class="f2">            completionHandler();</span>
<span class="f2">        }</span>
<span class="f2">    }];</span>
<span class="f2">}</span>

<span class="f2">- (NSMutableArray *)attachments {</span>
<span class="f2">    if (_attachments == nil) {</span>
<span class="f2">        _attachments = [[NSMutableArray alloc] init];</span>
<span class="f2">    }</span>
<span class="f2">    return _attachments;</span>
<span class="f2">}</span>

<span class="f2">- (NSMutableArray *)attachmentRanges {</span>
<span class="f2">    if (_attachmentRanges == nil) {</span>
<span class="f2">        _attachmentRanges = [[NSMutableArray alloc] init];</span>
<span class="f2">    }</span>
<span class="f2">    return _attachmentRanges;</span>
<span class="f2">}</span>

<span class="f2">- (NSMutableArray *)imageViews {</span>
<span class="f2">    if (_imageViews == nil) {</span>
<span class="f2">        _imageViews = [[NSMutableArray alloc] init];</span>
<span class="f2">    }</span>
<span class="f2">    return _imageViews;</span>
}

<span class="f2">- (void)clearImageViewsCover {</span>
<span class="f2">    [self.attachmentRanges removeAllObjects];</span>
<span class="f2">    [self.attachments removeAllObjects];</span>
<span class="f2">    </span>
<span class="f2">    for (UIImageView *imgView in self.imageViews) {</span>
<span class="f2">        [imgView removeFromSuperview];</span>
<span class="f2">    }</span>
<span class="f2">    [self.imageViews removeAllObjects];</span>
<span class="f2">}</span>

<span class="f2">- (UIImage *)placeHolderImage {</span>
<span class="f2">    static UIImage *holderImage = nil;</span>
<span class="f2">    if (holderImage == nil) {</span>
<span class="f2">        UIGraphicsBeginImageContextWithOptions(CGSizeMake(1, 1), NO, 0);</span>
<span class="f2">        CGContextRef context = UIGraphicsGetCurrentContext();</span>
<span class="f2">        CGContextSetFillColorWithColor(context, [UIColor colorWithWhite:0.8 alpha:1].CGColor);</span>
<span class="f2">        CGContextFillRect(context, CGRectMake(0, 0, 1, 1));</span>
<span class="f2">        holderImage = UIGraphicsGetImageFromCurrentImageContext();</span>
<span class="f2">        UIGraphicsEndImageContext();</span>
<span class="f2">    }</span>
<span class="f2">    return holderImage;</span>
<span class="f2">}</span>


<span class="f2">#pragma mark - Layout</span>

<span class="f2">- (void)layoutAttachments {</span>
<span class="f2">    NSInteger attachmentCount = [self.attachments count];</span>
<span class="f2">    for (NSInteger i = 0; i &lt; attachmentCount; i++) {</span>
<span class="f2">        NSRange range = [self.attachmentRanges[i] rangeValue];</span>
<span class="f2">        MMTextAttachment *attachment = self.attachments[i];</span>
<span class="f2">        UIImageView *imgView = self.imageViews[i];</span>

<span class="f2">        NSRange glyphRange = [self.layoutManager glyphRangeForCharacterRange:range actualCharacterRange:nil];</span>
<span class="f2">        CGRect rect = [self.layoutManager boundingRectForGlyphRange:glyphRange inTextContainer:self.textContainer];</span>
<span class="f2">        rect.origin.x += self.textContainerInset.left;</span>
<span class="f2">        rect.origin.y += self.textContainerInset.top;</span>

<span class="f2">        CGFloat originalY = CGRectGetMaxY(rect) - attachment.bounds.size.height;</span>
<span class="f2">        if(attachment.bounds.size.width == 20) {</span>
<span class="f2">            CGFloat lineHeight = self.mmFont.lineHeight;</span>
<span class="f2">            originalY = CGRectGetMaxY(rect) - lineHeight</span> / <span class="f1">****************************</span><span class="f2">2 - attachment.bounds.size.height / 2;</span>
<span class="f2">        }</span>
<span class="f2">        imgView.frame = CGRectMake(rect.origin.x, originalY, attachment.bounds.size.width, attachment.bounds.size.height);</span>
<span class="f2">        if ([imgView superview] == nil) {</span>
<span class="f2">            [self addSubview:imgView];</span>
<span class="f2">        }</span>
<span class="f2">    }</span>
<span class="f2">}</span>

<span class="f2">- (void)layoutSubviews {</span>
<span class="f2">    [super layoutSubviews];</span>
<span class="f2">    [self layoutAttachments];</span>
<span class="f2">}</span>

<span class="f2">- (void)copy:(id)sender {</span>
<span class="f2">    [UIPasteboard generalPasteboard].string = [self mmTextWithRange:self.selectedRange];</span>
<span class="f2">}</span>

<span class="f2">#pragma mark -</span> about url and phone number<span class="f1">*******************************/</span>

- (void)setURLAttributes {
    //search the content of MMtextView for URL and Phone number and set `link attribute` on them
    NSError *error = nil;
    MMDataDetector *dataDetector = [[MMDataDetector alloc] initWithTypes:NSTextCheckingTypeLink | NSTextCheckingTypePhoneNumber error:&amp;error];
    _urlMatches = [dataDetector matchesInString:self.attributedText.string
                                        options:0
                                          range:NSMakeRange(0, self.attributedText.string.length)];

    NSMutableAttributedString * attributedString = [self.attributedText mutableCopy];
    NSMutableParagraphStyle * paragraphStyle = [[NSMutableParagraphStyle alloc] init];
    [paragraphStyle setLineSpacing:0];
<span class="f6">@@ -148,7 +312,7 @@</span> - (void)setURLAttributes {
                             value:paragraphStyle
                             range:NSMakeRange(0, self.attributedText.string.length)];
    [self setAttributedText:attributedString];

    [self highlightLinksWithIndex:NSNotFound];
    //add tap gesture
    self.userInteractionEnabled = true;
<span class="f6">@@ -158,31 +322,31 @@</span> - (void)setURLAttributes {
}

- (void)highlightLinksWithIndex:(CFIndex)index {
<span class="f1">    </span>
    NSMutableAttributedString* attributedString = [self.attributedText mutableCopy];
    <span class="f2">if (self.textColor) {</span>
        [attributedString addAttribute:NSForegroundColorAttributeName
                                 value:self.textColor
                                 range:NSMakeRange(0, attributedString.string.length)];
    <span class="f2">}</span>
    for (NSTextCheckingResult *match in _urlMatches) {
<span class="f1">        </span>
        if ([match resultType] == NSTextCheckingTypeLink || [match resultType] == NSTextCheckingTypePhoneNumber) {
<span class="f1">            </span>
            NSRange matchRange = [match range];
<span class="f1">            </span>
            if ([self isIndex:index inRange:matchRange]) {
                [attributedString addAttribute:NSForegroundColorAttributeName value:[UIColor grayColor] range:matchRange];
            }
            else {
                [attributedString addAttribute:NSForegroundColorAttributeName value:[UIColor blueColor] range:matchRange];
            }
            [attributedString addAttribute:NSUnderlineStyleAttributeName
                                     value:[NSNumber numberWithInteger:NSUnderlineStyleSingle]
                                     range:matchRange];
        }
    }

    self.attributedText = attributedString;
}

- (BOOL)isIndex:(CFIndex)index inRange:(NSRange)range {
    return index &gt; range.location &amp;&amp; index &lt; range.location+range.length;
}

<span class="f6">@@ -194,10 +358,9 @@</span> - (void)handleTap:(UITapGestureRecognizer *)gestureRecognizer {
    if (!result) {
        return;
    }

    switch (result.resultType) {
        case NSTextCheckingTypeLink:
<span class="f1">            NSLog(@&quot;link&quot;);</span>
            if ([self.clickActionDelegate respondsToSelector:@selector(mmTextView:didSelectLinkWithURL:)]) {
                [self.clickActionDelegate mmTextView:self didSelectLinkWithURL:result.URL];
            }
<span class="f6">@@ -206,7 +369,6 @@</span> - (void)handleTap:(UITapGestureRecognizer *)gestureRecognizer {
            if ([self.clickActionDelegate respondsToSelector:@selector(mmTextView:didSelectLinkWithPhoneNumber:)]) {
                [self.clickActionDelegate mmTextView:self didSelectLinkWithPhoneNumber:result.phoneNumber];
            }
<span class="f1">            NSLog(@&quot;tele&quot;);</span>
            break;
        default:
            break;
<span class="f6">@@ -225,118 +387,102 @@</span> - (NSTextCheckingResult *)linkAtCharacterIndex:(CFIndex)idx {
            return result;
        }
    }
<span class="f1">    </span>
    return nil;
}

- (CFIndex)characterIndexAtPoint:(CGPoint)point {
<span class="f1">    </span>
    NSMutableAttributedString *optimizedAttributedText = [self.attributedText mutableCopy];
<span class="f1">    </span>
    // use label's font and lineBreakMode properties in case the attributedText does not contain such attributes
    [self.attributedText enumerateAttributesInRange:NSMakeRange(0, [self.attributedText length])
                                            options:0
                                         usingBlock:^(NSDictionary *attrs, NSRange range, BOOL *stop) {
                                             if (!attrs[(NSString *)kCTFontAttributeName]) {

                                                 [optimizedAttributedText addAttribute:(NSString *)kCTFontAttributeName
                                                                                 value:self.font
                                                                                 range:NSMakeRange(0, [self.attributedText length])];
                                             }
                                         }];

    // modify kCTLineBreakByTruncatingTail lineBreakMode to kCTLineBreakByWordWrapping
    [optimizedAttributedText enumerateAttribute:(NSString *)kCTParagraphStyleAttributeName
                                        inRange:NSMakeRange(0, [optimizedAttributedText length])
                                        options:0
                                     usingBlock:^(id value, NSRange range, BOOL *stop) {
                                         NSMutableParagraphStyle *paragraphStyle = [value mutableCopy];

                                         if ([paragraphStyle lineBreakMode] == kCTLineBreakByTruncatingTail) {
                                             [paragraphStyle setLineBreakMode:NSLineBreakByWordWrapping];
                                         }

                                         [optimizedAttributedText removeAttribute:(NSString *)kCTParagraphStyleAttributeName range:range];
                                         [optimizedAttributedText addAttribute:(NSString *)kCTParagraphStyleAttributeName
                                                                         value:paragraphStyle
                                                                         range:range];
                                     }];<span class="f1">////////</span>

    if (!CGRectContainsPoint(self.bounds, point)) {
        return NSNotFound;
    }

    CGRect textRect = [self frame];
<span class="f1">    </span>
    if (!CGRectContainsPoint(textRect, point)) {
        return NSNotFound;
    }

    // Offset tap coordinates by textRect origin to make them relative to the origin of frame
    point = CGPointMake(point.x - textRect.origin.x, point.y - textRect.origin.y);
    // Convert tap coordinates (start at top left) to CT coordinates (start at bottom left)
    point = CGPointMake(point.x, textRect.size.height - point.y);

    //////

    CTFramesetterRef framesetter = CTFramesetterCreateWithAttributedString((__bridge CFAttributedStringRef)optimizedAttributedText);

    CGMutablePathRef path = CGPathCreateMutable();
    CGPathAddRect(path, NULL, textRect);

    CTFrameRef frame = CTFramesetterCreateFrame(framesetter, CFRangeMake(0, [self.attributedText length]), path, NULL);

    if (frame == NULL) {
        CFRelease(path);
        <span class="f2">CFRelease(framesetter);</span>
        return NSNotFound;
    }

    CFArrayRef lines = CTFrameGetLines(frame);
<span class="f1">    </span>
    NSInteger numberOfLines = CFArrayGetCount(lines);
<span class="f1">    </span>
<span class="f1">    // DebugLog(@&quot;num lines: %d&quot;, numberOfLines);</span>
<span class="f1">    </span>
    if (numberOfLines == 0) {
        CFRelease(frame);
        CFRelease(path);
        <span class="f2">CFRelease(framesetter);</span>
        return NSNotFound;
    }

    NSUInteger idx = NSNotFound;
<span class="f1">    </span>
    CGPoint lineOrigins[numberOfLines];

    CTFrameGetLineOrigins(frame, CFRangeMake(0, numberOfLines), lineOrigins);
<span class="f1">    </span>
    for (CFIndex lineIndex = 0; lineIndex &lt; numberOfLines; lineIndex++) {
<span class="f1">        </span>
        CGPoint lineOrigin = lineOrigins[lineIndex];
        CTLineRef line = CFArrayGetValueAtIndex(lines, lineIndex);

        // Get bounding information of line
        CGFloat ascent, descent, leading, width;
        width = CTLineGetTypographicBounds(line, &amp;ascent, &amp;descent, &amp;leading);
        CGFloat yMin = floor(lineOrigin.y - descent);
        CGFloat yMax = ceil(lineOrigin.y + ascent);

        // Check if we've already passed the line
        if (point.y &gt; yMax) {
            break;
        }

        // Check if the point is within this line vertically
        if (point.y &gt;= yMin) {
<span class="f1">            </span>
            // Check if the point is within this line horizontally
            if (point.x &gt;= lineOrigin.x &amp;&amp; point.x &lt;= lineOrigin.x + width) {

                // Convert CT coordinates to line-relative coordinates
                CGPoint relativePoint = CGPointMake(point.x - lineOrigin.x, point.y - lineOrigin.y);
                idx = CTLineGetStringIndexForPosition(line, relativePoint);
<span class="f6">@@ -345,144 +491,11 @@</span> - (CFIndex)characterIndexAtPoint:(CGPoint)point {
            }
        }
    }
<span class="f1">    </span>
    CFRelease(frame);
    CFRelease(path);
    <span class="f2">CFRelease(framesetter);</span>
    return idx;
}
<span class="f1">/****************************about url and phone number*******************************/</span>

<span class="f1">- (void)updateAttributeTextWithData:(NSArray*)extData completionHandler:(void(^)(void))completionHandler {</span>
<span class="f1">    NSMutableArray *codes = [NSMutableArray array];</span>
<span class="f1">    __block NSMutableArray *textImgArray = [NSMutableArray array];</span>
<span class="f1">    for (NSArray *obj in extData) {</span>
<span class="f1">        NSString *str = obj[0];</span>
<span class="f1">        BOOL isEmoji = [obj[1] integerValue] == 0 ? NO : YES;</span>
<span class="f1">        if (isEmoji) {</span>
<span class="f1">            if (![codes containsObject:str]) {</span>
<span class="f1">                [codes addObject:str];</span>
<span class="f1">            }</span>
<span class="f1">        }</span>
<span class="f1">        [textImgArray addObject:str];</span>
<span class="f1">    }</span>
<span class="f1">    </span>
<span class="f1">    //</span>
<span class="f1">    [[MMEmotionCentre defaultCentre] fetchEmojisByType:MMFetchTypeAll codes:codes completionHandler:^(NSArray *emojis) {</span>
<span class="f1">        NSMutableAttributedString *mAStr = [[NSMutableAttributedString alloc] init];</span>
<span class="f1">        for (MMEmoji *emoji in emojis) {</span>
<span class="f1">            NSInteger objIndex = [textImgArray indexOfObject:emoji.emojiCode];</span>
<span class="f1">            while (objIndex != NSNotFound) {</span>
<span class="f1">                [textImgArray replaceObjectAtIndex:objIndex withObject:emoji];</span>
<span class="f1">                objIndex = [textImgArray indexOfObject:emoji.emojiCode];</span>
<span class="f1">            }</span>
<span class="f1">        }</span>
<span class="f1">        for (id obj in textImgArray) {</span>
<span class="f1">            if ([obj isKindOfClass:[MMEmoji class]]) {</span>
<span class="f1">                MMTextAttachment *attachment = [[MMTextAttachment alloc] init];</span>
<span class="f1">                attachment.emoji = obj;</span>
<span class="f1">                if ([attachment.image.images count] &gt; 1) {</span>
<span class="f1">                    attachment.image = [attachment placeHolderImage];</span>
<span class="f1">                }</span>
<span class="f1">                [mAStr appendAttributedString:[NSAttributedString attributedStringWithAttachment:attachment]];</span>
<span class="f1">            } else {</span>
<span class="f1">                [mAStr appendAttributedString:[[NSAttributedString alloc] initWithString:obj]];</span>
<span class="f1">            }</span>
<span class="f1">        }</span>
<span class="f1">        if (self.mmFont) {</span>
<span class="f1">            [mAStr addAttribute:NSFontAttributeName value:self.mmFont range:NSMakeRange(0, mAStr.length)];</span>
<span class="f1">        }</span>
<span class="f1">        if (self.mmTextColor) {</span>
<span class="f1">            [mAStr addAttribute:NSForegroundColorAttributeName value:self.mmTextColor range:NSMakeRange(0, mAStr.length)];</span>
<span class="f1">        }</span>
<span class="f1">        self.attributedText = mAStr;</span>
<span class="f1">        if (completionHandler) {</span>
<span class="f1">            completionHandler();</span>
<span class="f1">        }</span>
<span class="f1">    }];</span>
<span class="f1">}</span>

<span class="f1">- (NSMutableArray *)attachments {</span>
<span class="f1">    if (_attachments == nil) {</span>
<span class="f1">        _attachments = [[NSMutableArray alloc] init];</span>
<span class="f1">    }</span>
<span class="f1">    return _attachments;</span>
<span class="f1">}</span>

<span class="f1">- (NSMutableArray *)attachmentRanges {</span>
<span class="f1">    if (_attachmentRanges == nil) {</span>
<span class="f1">        _attachmentRanges = [[NSMutableArray alloc] init];</span>
<span class="f1">    }</span>
<span class="f1">    return _attachmentRanges;</span>
<span class="f1">}</span>

<span class="f1">- (NSMutableArray *)imageViews {</span>
<span class="f1">    if (_imageViews == nil) {</span>
<span class="f1">        _imageViews = [[NSMutableArray alloc] init];</span>
<span class="f1">    }</span>
<span class="f1">    return _imageViews;</span>
<span class="f1">}</span>

<span class="f1">#pragma mark - private</span>

<span class="f1">- (void)clearImageViewsCover {</span>
<span class="f1">    [self.attachmentRanges removeAllObjects];</span>
<span class="f1">    [self.attachments removeAllObjects];</span>
<span class="f1">    </span>
<span class="f1">    for (UIImageView *imgView in self.imageViews) {</span>
<span class="f1">        [imgView removeFromSuperview];</span>
<span class="f1">    }</span>
<span class="f1">    [self.imageViews removeAllObjects];</span>
<span class="f1">}</span>

<span class="f1">- (UIImage *)placeHolderImage {</span>
<span class="f1">    static UIImage *holderImage = nil;</span>
<span class="f1">    if (holderImage == nil) {</span>
<span class="f1">        UIGraphicsBeginImageContextWithOptions(CGSizeMake(1, 1), NO, 0);</span>
<span class="f1">        CGContextRef context = UIGraphicsGetCurrentContext();</span>
<span class="f1">        CGContextSetFillColorWithColor(context, [UIColor colorWithWhite:0.8 alpha:1].CGColor);</span>
<span class="f1">        CGContextFillRect(context, CGRectMake(0, 0, 1, 1));</span>
<span class="f1">        holderImage = UIGraphicsGetImageFromCurrentImageContext();</span>
<span class="f1">        UIGraphicsEndImageContext();</span>
<span class="f1">    }</span>
<span class="f1">    return holderImage;</span>
<span class="f1">}</span>


<span class="f1">#pragma mark - Layout</span>

<span class="f1">- (void)layoutAttachments {</span>
<span class="f1">    NSInteger attachmentCount = [self.attachments count];</span>
<span class="f1">    for (NSInteger i = 0; i &lt; attachmentCount; i++) {</span>
<span class="f1">        NSRange range = [self.attachmentRanges[i] rangeValue];</span>
<span class="f1">        MMTextAttachment *attachment = self.attachments[i];</span>
<span class="f1">        UIImageView *imgView = self.imageViews[i];</span>

<span class="f1">        NSRange glyphRange = [self.layoutManager glyphRangeForCharacterRange:range actualCharacterRange:nil];</span>
<span class="f1">        CGRect rect = [self.layoutManager boundingRectForGlyphRange:glyphRange inTextContainer:self.textContainer];</span>
<span class="f1">        rect.origin.x += self.textContainerInset.left;</span>
<span class="f1">        rect.origin.y += self.textContainerInset.top;</span>

<span class="f1">        CGFloat originalY = CGRectGetMaxY(rect) - attachment.bounds.size.height;</span>
<span class="f1">        if(attachment.bounds.size.width == 20) {</span>
<span class="f1">            CGFloat lineHeight = self.mmFont.lineHeight;</span>
<span class="f1">            originalY = CGRectGetMaxY(rect) - lineHeight / 2 - attachment.bounds.size.height / 2;</span>
<span class="f1">        }</span>
<span class="f1">        imgView.frame = CGRectMake(rect.origin.x, originalY, attachment.bounds.size.width, attachment.bounds.size.height);</span>
<span class="f1">        if ([imgView superview] == nil) {</span>
<span class="f1">            [self addSubview:imgView];</span>
<span class="f1">        }</span>
<span class="f1">    }</span>
<span class="f1">}</span>

<span class="f1">- (void)layoutSubviews {</span>
<span class="f1">    [super layoutSubviews];</span>
<span class="f1">    [self layoutAttachments];</span>
<span class="f1">}</span>

<span class="f1">- (void)copy:(id)sender {</span>
<span class="f1">    [UIPasteboard generalPasteboard].string = [self mmTextWithRange:self.selectedRange];</span>
<span class="f1">}</span>


@end
<span class="bold">diff --git a/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/GrowingTextView/HPGrowingTextView.h b/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/GrowingTextView/HPGrowingTextView.h</span>
<span class="bold">index e689a11..8818390 100755</span>
<span class="bold">--- a/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/GrowingTextView/HPGrowingTextView.h</span>
<span class="bold">+++ b/ECSDKDemo_OC/ECSDKDemo_OC/thirdparty/GrowingTextView/HPGrowingTextView.h</span>
<span class="f6">@@ -26,7 +26,7 @@</span>
//	THE SOFTWARE.

#import &lt;UIKit/UIKit.h&gt;
<span class="f2">#import &lt;BQMM/BQMM.h&gt;  //BQMM集成</span>
#if __IPHONE_OS_VERSION_MAX_ALLOWED &lt; 60000
	// UITextAlignment is deprecated in iOS 6.0+, use NSTextAlignment instead.
	// Reference: https://developer.apple.com/library/ios/documentation/uikit/reference/NSString_UIKit_Additions/Reference/Reference.html
</pre>
</body>
</html>
